# (PART)GAP ANALYSIS {.unnumbered}

## Impact of housing costs on household budgets {#part-3-2}

```{r setup}

library(tidyverse)
library(httr)
library(glue)
library(readxl)
library(janitor)
library(ggplot2)
library(simplevis)
library(stats)
library(lubridate)
library(scales)
library(plotly)

```

```{r chas, eval=FALSE}
# years <- 2015:2018
# 
# sumlev <- "050"
# 
# dir.create(glue("data/{sumlev}"))
# 
# walk(years, ~{
#   
#   url <- glue("https://www.huduser.gov/PORTAL/datasets/cp/{.x - 4}thru{.x}-{sumlev}-csv.zip")
#   
#   file <- basename(url)
#   
#   path <- file.path("data", sumlev, file)
#   
#   if (!file.exists(path)) {
#     GET(url, write_disk(path, overwrite = TRUE), progress(type = "down"))
#   }
#   
#   print(glue("Unzipping {.x}..."))
#   unzip(path, exdir = file.path("data", sumlev, .x))
#   
# })
# 
# years <- 2015:2018
# 
# # Tables to get
# tables <- c(7, 9, paste0(18, LETTERS[1:3]))
# 
# # Go through and write out the various tables
# walk(tables, function(table) {
#   
#   mytable <- purrr::map_df(years, function(year) {
#     
#     # Identify the year-specific folder
#     path <- file.path("data", "050", year)
#     
#     # Find the file - it may be buried so use recursive = TRUE
#     file <- list.files(path, pattern = glue("Table{table}.csv"), recursive = TRUE)
#     
#     # Read in the file quietly
#     raw <- read_csv(file.path(path, file), col_types = cols())
#     
#     # Clean it up
#     cleaned <- raw |> 
#       clean_names() |> 
#       mutate(fips = substr(geoid, 8, 12)) |> 
#       separate(name, into = c("county", "state"), sep = ",") |> 
#       filter(st == "51") |> 
#       pivot_longer(starts_with("T"), 
#                    names_to = "code",
#                    values_to = "value") |> 
#       mutate(id = str_extract(code, "\\d+$"),
#              type = str_extract(code, "est|moe")) |> 
#       select(-code) |> 
#       pivot_wider(names_from = type, values_from = value) |> 
#       rename(Estimate = est, MOE = moe) |> 
#       mutate(Code := glue("T{table}_est{id}"),
#              Year = year) |> 
#       select(Code, Year, Estimate, MOE, everything(), -id) |>       
#       mutate(fips = case_when(
#         fips == "51515" ~ "51019",
#         TRUE ~ fips
#       )) |> 
#       mutate(county = case_when(
#         county == "Bedford city" ~ "Bedford County",
#         TRUE ~ county
#       )) |> 
#       subset(fips %in% rr)
#     
#     # Account for different data dictionaries
#     # Find the data dictionary in the appropriate folder
#     dict_path <- list.files(path, pattern = "dictionary", recursive = TRUE, full.names = TRUE) 
#     
#     # Read in the data dictionary and merge
#     dict <- read_excel(dict_path, 
#                        sheet = glue("Table {table}"))
#     
#     cleaned_with_dict <- cleaned %>%
#       left_join(dict, by = c("Code" = "Column Name"))
#     
#     cleaned_with_dict
#     
#   }) 
#   
#   file_name <- glue("Table{table}_2015to2018.csv")
#   
#   message(glue("Writing file {file_name}..."))
#   
#   write_csv(mytable, glue("data/{file_name}"))
#   
# })

# Consider adding script to remove the "data/050" file folder of zips and tables to create space.

# file.remove()


```

### Cost burden

The share of cost-burdened households has been decreasing across the region from 2015 to 2018. In nearly every locality, the share of cost-burdened households has decreased by three percentage points. This seems surprising given the growing affordability challenges experienced by the region's residents.


```{r cb-locality, fig.cap= Share of cost-burdened households by locality. Source: Comprehensive Housing Affordability Strategy (CHAS)."}

income_pha_perc <- cb_7 |> 
  subset(county %in% pha_localities) |> 
  group_by(year, county, household_income, cb_group) |>
  summarise(estimate = sum(estimate))

income_pha_perc <- income_pha_perc |> 
  transform(percent = ave(estimate, year, county, FUN = prop.table))

income_pha_perc_18 <- income_pha_perc |> 
  filter(year == 2018 | year == 2015) |> 
  select(year,county, household_income, cb_group, estimate) |> 
  group_by(year, county, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  transform(percent = ave(estimate, year, county, FUN = prop.table))

cb_share <- ggplot(income_pha_perc_18,
       aes(x = county,
           y = percent,
           fill = forcats::fct_rev(cb_group))) +
  facet_wrap(~year) +
  geom_bar(stat = "identity", position = "stack") +
  scale_y_continuous(labels = percent_format()) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle= 90, hjust = 1, vjust = 1)) +
  labs(title = "Share of cost-burdened households by locality", fill = "Cost burden") +
  scale_fill_manual(values = c("grey", "red"))

ggplotly(cb_share) |> 
  plotly_camera()

```

```{r cb-tenure, fig.cap="Change in housing cost burden by tenure. Source: Comprehensive Housing Affordability Strategy (CHAS)."}

cb_tenure_pha <- cb_7 |> 
  subset(county %in% pha_localities) |> 
  group_by(year, county, tenure, cb_group) |> 
  summarise(estimate = sum(estimate)) |>
  pivot_wider(
    names_from = year,
    values_from = estimate
  ) |> 
  clean_names() |> 
  transform(difference = (x2018 - x2015))


cb_tenure_pha <- cb_tenure_pha |> 
  filter(cb_group == "Cost-burdened")

cb_tenure_bar <- ggplot(cb_tenure_pha,
       aes(x = county,
           y = difference,
           fill = tenure)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~tenure) +
  labs(title = "Change in housing cost burden by tenure: 2015 to 2018") +
  theme(legend.position = "none",
        axis.title = element_blank()) + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1))

ggplotly(cb_tenure_bar) |> 
  plotly_camera()

```

```{r cb-income, fig.cap="Change in housing cost burden by AMI. Source: Comprehensive Housing Affordability Strategy (CHAS)."}

cb_7 <- read_csv("data/Table7_2015to2018.csv") |> 
  clean_names() |> 
  filter(line_type == "Detail") |> 
  select(year, estimate, moe, county, fips, tenure, household_income, household_type, cost_burden) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied" ~ "Homeowner",
    tenure == "Renter occupied" ~ "Renter"
  )) |> 
  mutate(household_income = case_when(
    household_income == "household income is less than or equal to 30% of HAMFI" ~ "30% AMI or less",
    household_income == "household income is greater than 30% but less than or equal to 50% of HAMFI" ~ "31 to 50% AMI",
    household_income == "household income is greater than 50% but less than or equal to 80% of HAMFI" ~ "51 to 80% AMI",
    household_income == "household income is greater than 80% but less than or equal to 100% of HAMFI" ~ "81 to 100% AMI", 
    household_income == "household income is greater than 100% of HAMFI" ~ "101% AMI or greater"
  )) |> 
  mutate(household_type = case_when(
    household_type == "household type is elderly family (2 persons, with either or both age 62 or over)" ~ "Elderly family",
    household_type == "household type is small family (2 persons, neither person 62 years or over, or 3 or 4 persons)" ~ "Small family",
    household_type == "household type is large family (5 or more persons)" ~ "Large family",
    household_type == "household type is elderly non-family" ~ "Elderly non-family", 
    household_type == "other household type (non-elderly non-family)" ~ "Non-elderly non-family"
  ))  |> 
  mutate(cost_burden = case_when(
    cost_burden == "housing cost burden is less than or equal to 30%" ~ "Not cost-burdened", 
    cost_burden == "housing cost burden is greater than 30% but less than or equal to 50%" ~ "Cost-burdened",
    cost_burden == "housing cost burden is greater than 50%" ~ "Severely cost-burdened",
    cost_burden == "housing cost burden not computed (household has no/negative income)" ~ "No or negative income"
  )) |> 
  mutate(cb_group = case_when(
    cost_burden == "Cost-burdened" ~ "Cost-burdened",
    cost_burden == "Severely cost-burdened" ~ "Cost-burdened",
    cost_burden == "No or negative income" ~ "Cost-burdened",
    TRUE ~ cost_burden
  ))

pha_localities <- c("Richmond city", "Chesterfield County", "Hanover County", "Henrico County")

cb_7_pha <- cb_7 |> 
  subset(county %in% pha_localities) |> 
  group_by(year, household_income, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(
    names_from = year,
    values_from = estimate
  ) |> 
  clean_names() |> 
  transform(difference = (x2018 - x2015))

cb_income_pha <- cb_7_pha |> 
  filter(cb_group == "Cost-burdened")

ggplot(cb_income_pha,
       aes(x = household_income,
           y = difference,
           fill = household_income)) +
  geom_bar(stat = "identity") +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust =1)) +
  scale_x_discrete(limits= c("30% AMI or less", "31 to 50% AMI", "51 to 80% AMI", "81 to 100% AMI", "101% AMI or greater")) +
  scale_fill_discrete(limits= c("30% AMI or less", "31 to 50% AMI", "51 to 80% AMI", "81 to 100% AMI", "101% AMI or greater")) +
  labs(title = "Change in housing cost burden by AMI: 2015 to 2018", fill = "AMI")
  

```





```{r cb-hh, fig.cap="Change in housing cost burden by household type. Source: Comprehensive Housing Affordability Strategy (CHAS)."}

cb_hh_pha <- cb_7 |> 
  subset(county %in% pha_localities) |> 
  group_by(year, county, household_type, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(
    names_from = year,
    values_from = estimate
  ) |> 
  clean_names() |> 
  transform(difference = (x2018 - x2015)) |> 
  filter(cb_group == "Cost-burdened")

ggplot(cb_hh_pha,
       aes(x = household_type,
           y = difference,
           fill = household_type)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~county) +
  labs(title = "Change in housing cost burden by housing type: 2015 to 2018") +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1))


```

### Mortgage delinquency and foreclosure

```{r mort-del, fig.cap="Mortgage delinquency rate by locality. Source: Consumer Financial Protection Bureau (CFPB)."}

pha_localities <- c("Richmond city", "Chesterfield County", "Hanover County", "Henrico County")

mort_del <- read_csv("data/mortgage_del.csv") |> 
  pivot_longer(
    cols = starts_with("2"),
    names_to = "period",
    values_to = "estimate"
  )|> 
  mutate(period = ym(period)) |> 
  filter(State == "VA") |> 
  subset(Name %in% pha_localities) |> 
  mutate(estimate = estimate/100)

ggplot(mort_del,
       aes(x = period,
           y = estimate,
           color = Name)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~Name) +
  scale_y_continuous(labels = percent_format()) +
  theme(axis.title = element_blank()) +
  labs(title = "Mortgage delinquency rate by locality: 2008 through 2021", color = "Locality")


```

### Eviction filings and judgements
```{r evictions, fig.cap="Evictions and filings by locality. Source: RVA Eviction Lab"}

evictions <- read_csv("data/evictions_17_22.csv") |> 
  pivot_longer(3:128,
               names_to = "data",
               values_to = "value") |> 
  mutate(type = case_when(
    str_detect(data, "Filings") ~ "Filings",
    str_detect(data,"Evictions") ~ "Evictions"
  )) |> 
  mutate(date = str_sub(data, -7, -1)) |> 
  mutate(date = ym(date))

ggplot(evictions,
       aes(x = date,
           y = value,
           fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~Jurisdiction) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  labs(title = "Evictions and filings by locality: 2017 through Q3 2022", fill = "Action")
  

```

### Housing Resource Line
```{r call-vol, fig.cap="PHA Housing Resource Line call volume. Source: Partnership for Housing Affordability."}

call_vol <- read_csv("data/hrl_vol.csv") |> 
  mutate(date = ym(date))

call_vol_bar <- ggplot(call_vol,
       aes(x = date,
           y = volume)) +
  geom_bar(stat = "identity", fill = "red") +
  labs(title = "PHA Housing Resource Line call volume") +
  theme(axis.title = element_blank())

call_vol_bar

```

```{r call-topic}

call_top <- read_csv("data/hrl_need.csv")

call_top_bar <- ggplot(call_top,
       aes(x = reorder(need, vol), 
           y = vol,
           fill = need)) +
  geom_bar(stat = "identity") + 
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  labs(title = "PHA Housing Resource Line call volume by topic") +
  coord_flip()

call_top_bar

```


### Homelessness
```{r pit}

years <- as.character(2007:2021)

path <- "data/2007-2021-PIT-Counts-by-CoC.xlsx"

full_set <- map_dfr(years, function(yr) {
  

pit_set <- read_excel(path, sheet = yr) |> 
    clean_names()

suffix_to_remove <- paste0("_", yr)
  
  if ("co_c_category" %in% names(pit_set)) {
    pit_renamed <- pit_set %>%
      rename_with(~str_remove(.x, suffix_to_remove)) |> 
      mutate(year = yr) %>%
      select(co_c_number:co_c_name, co_c_category, type_of_count, year, everything()) |> 
      mutate(across(-c(co_c_number:year), .fns = as.numeric))
  } else {
    pit_renamed <- pit_set %>%
      rename_with(~str_remove(.x, suffix_to_remove)) |> 
      mutate(year = yr, co_c_category = NA_character_, 
             type_of_count = NA_character_) |> 
      select(co_c_number:co_c_name, co_c_category, type_of_count, year, everything()) |> 
      mutate(across(-c(co_c_number:year), .fns = as.numeric))
  }
  
  pit_renamed
  
})

full_set_longer <- full_set %>%
  pivot_longer(
    cols = overall_homeless:unsheltered_homeless_parenting_youth_under_25_multiple_races, 
    names_to = "category",
    values_to = "value"
  )

rva_coc <- full_set_longer |> 
  filter(co_c_number == "VA-500") |> 
  filter(str_detect(category, "overall_homeless"))

rva_pit <- rva_coc |> 
  filter(category == "overall_homeless")

rva_pit_bar <- ggplot(rva_pit,
       aes(x = year,
           y = value)) +
  geom_bar(stat = "identity", fill = "dark green") +
  labs(title = "Richmond Continuum-of-Care Point-in-Time count") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(big.mark = ","))

rva_pit_bar


```


```{r mkv}

div <- c(21, 42, 43, 123)

mkv <- read_csv("data/mkv.csv") |> 
  subset(Division %in% div)

mkv_bar <- ggplot(mkv,
       aes(x = year,
           y = students,
           fill = Name)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Name) +
  labs(title = "Enrolled students experiencing homelessness by school year", fill = "School division") +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_y_continuous(labels = number_format(big.mark = ","))

mkv_bar

```

