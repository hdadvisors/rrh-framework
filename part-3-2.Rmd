# Impact of housing costs on household budgets {#part-3-2}

```{r setup}

library(tidyverse)
library(httr)
library(glue)
library(readxl)
library(janitor)
library(ggplot2)
library(simplevis)
library(stats)
library(lubridate)
library(scales)
library(plotly)

```

```{r chas-pull, eval=FALSE}

# years <- 2015:2018
# 
# sumlev <- "050"
# 
# dir.create(glue("data/{sumlev}"))
# 
# walk(years, ~{
#   
#   url <- glue("https://www.huduser.gov/PORTAL/datasets/cp/{.x - 4}thru{.x}-{sumlev}-csv.zip")
#   
#   file <- basename(url)
#   
#   path <- file.path("data", sumlev, file)
#   
#   if (!file.exists(path)) {
#     GET(url, write_disk(path, overwrite = TRUE), progress(type = "down"))
#   }
#   
#   print(glue("Unzipping {.x}..."))
#   unzip(path, exdir = file.path("data", sumlev, .x))
#   
# })
# 
# years <- 2015:2018
# 
# # Tables to get
# tables <- c(7, 9, paste0(18, LETTERS[1:3]))
# 
# # Go through and write out the various tables
# walk(tables, function(table) {
#   
#   mytable <- purrr::map_df(years, function(year) {
#     
#     # Identify the year-specific folder
#     path <- file.path("data", "050", year)
#     
#     # Find the file - it may be buried so use recursive = TRUE
#     file <- list.files(path, pattern = glue("Table{table}.csv"), recursive = TRUE)
#     
#     # Read in the file quietly
#     raw <- read_csv(file.path(path, file), col_types = cols())
#     
#     # Clean it up
#     cleaned <- raw |> 
#       clean_names() |> 
#       mutate(fips = substr(geoid, 8, 12)) |> 
#       separate(name, into = c("county", "state"), sep = ",") |> 
#       filter(st == "51") |> 
#       pivot_longer(starts_with("T"), 
#                    names_to = "code",
#                    values_to = "value") |> 
#       mutate(id = str_extract(code, "\\d+$"),
#              type = str_extract(code, "est|moe")) |> 
#       select(-code) |> 
#       pivot_wider(names_from = type, values_from = value) |> 
#       rename(Estimate = est, MOE = moe) |> 
#       mutate(Code := glue("T{table}_est{id}"),
#              Year = year) |> 
#       select(Code, Year, Estimate, MOE, everything(), -id) |>       
#       mutate(fips = case_when(
#         fips == "51515" ~ "51019",
#         TRUE ~ fips
#       )) |> 
#       mutate(county = case_when(
#         county == "Bedford city" ~ "Bedford County",
#         TRUE ~ county
#       )) |> 
#       subset(fips %in% rr)
#     
#     # Account for different data dictionaries
#     # Find the data dictionary in the appropriate folder
#     dict_path <- list.files(path, pattern = "dictionary", recursive = TRUE, full.names = TRUE) 
#     
#     # Read in the data dictionary and merge
#     dict <- read_excel(dict_path, 
#                        sheet = glue("Table {table}"))
#     
#     cleaned_with_dict <- cleaned %>%
#       left_join(dict, by = c("Code" = "Column Name"))
#     
#     cleaned_with_dict
#     
#   }) 
#   
#   file_name <- glue("Table{table}_2015to2018.csv")
#   
#   message(glue("Writing file {file_name}..."))
#   
#   write_csv(mytable, glue("data/{file_name}"))
#   
# })

# Consider adding script to remove the "data/050" file folder of zips and tables to create space.

# file.remove()


```

```{r chas-data}

# cb_7 <- read_csv("data/Table7_2015to2018.csv") |>
#   clean_names() |>
#   filter(line_type == "Detail") |>
#   select(year, estimate, moe, county, fips, tenure, household_income, household_type, cost_burden) |>
#   mutate(tenure = case_when(
#     tenure == "Owner occupied" ~ "Homeowner",
#     tenure == "Renter occupied" ~ "Renter"
#   )) |>
#   mutate(household_income = case_when(
#     household_income == "household income is less than or equal to 30% of HAMFI" ~ "30% AMI or less",
#     household_income == "household income is greater than 30% but less than or equal to 50% of HAMFI" ~ "31 to 50% AMI",
#     household_income == "household income is greater than 50% but less than or equal to 80% of HAMFI" ~ "51 to 80% AMI",
#     household_income == "household income is greater than 80% but less than or equal to 100% of HAMFI" ~ "81 to 100% AMI",
#     household_income == "household income is greater than 100% of HAMFI" ~ "101% AMI or greater"
#   )) |>
#   mutate(household_type = case_when(
#     household_type == "household type is elderly family (2 persons, with either or both age 62 or over)" ~ "Elderly family",
#     household_type == "household type is small family (2 persons, neither person 62 years or over, or 3 or 4 persons)" ~ "Small family",
#     household_type == "household type is large family (5 or more persons)" ~ "Large family",
#     household_type == "household type is elderly non-family" ~ "Elderly non-family",
#     household_type == "other household type (non-elderly non-family)" ~ "Non-elderly non-family"
#   ))  |>
#   mutate(cost_burden = case_when(
#     cost_burden == "housing cost burden is less than or equal to 30%" ~ "Not cost-burdened",
#     cost_burden == "housing cost burden is greater than 30% but less than or equal to 50%" ~ "Cost-burdened",
#     cost_burden == "housing cost burden is greater than 50%" ~ "Severely cost-burdened",
#     cost_burden == "housing cost burden not computed (household has no/negative income)" ~ "No or negative income"
#   )) |>
#   mutate(cb_group = case_when(
#     cost_burden == "Cost-burdened" ~ "Cost-burdened",
#     cost_burden == "Severely cost-burdened" ~ "Cost-burdened",
#     TRUE ~ cost_burden
#   ))
# 
# write_rds(cb_7, "data/cb_7.rds")

cb_7 <- read_rds("data/cb_7.rds")

pha_localities <- c("Richmond city", "Chesterfield County", "Hanover County", "Henrico County")

```

## Cost burden

When incomes don't rise along with housing costs, we can expect an increase in the number of cost-burdened households who pay more than 30 percent of their gross income on basic housing expenses. Since 2015, cost burden levels in the region decreased for some groups, while increased for others.

Data in this section come from the Comprehensive Housing Affordability Strategy (CHAS) dataset published by the U.S. Department of Housing and Urban Development. CHAS estimates are a custom tabulation of American Community Survey responses. As of August 2022, the most recent CHAS data is for the 2014-2018 5-year period.

Unless otherwise noted, all plots on this page combine data from Chesterfield County, Hanover County, Henrico County, and Richmond city.

### Cost burden by tenure

The number of cost-burdened homeowners across the region has declined significantly since 2015, particularly in Chesterfield and Henrico counties. Hanover County and Richmond city saw smaller decreases, but the total "loss" of cost-burdened homeowners in the region still exceeded 6,300.

Meanwhile, the total number of cost-burdened renter households increased by almost 1,500, with only Hanover County seeing a small decline. Much of this growth was focused in Chesterfield County and Richmond city.

```{r cb-locality, fig.cap = "Cumulative change in cost-burdened households by tenure"}

cb_locality <- cb_7 |> 
  filter(county %in% pha_localities,
         cb_group == "Cost-burdened") |> 
  group_by(year, county, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change))
  
ggplot(cb_locality,
       aes(x = year, y = run_diff, fill = tenure)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(county)) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = "Cumulative change in cost-burdened households by tenure",
       subtitle = "2015 to 2018",
       fill = "Tenure",
       caption = "Source: U.S Department of Housing and Urban Development,\nComprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(axis.title = element_blank())


```

### Cost burden by income

Homeowners above 80 percent AMI saw the largest declines in cost burden since 2016. This is likely due to rising incomes among homeowners with relatively fixed housing costs. Renters with cost burdens shifted up the income spectrum, as the number of cost-burdened renters below 30 percent AMI decreased by more than 1,400, but increased more than 2,705 among those between 30 and 100 percent AMI.

```{r cb-income, fig.cap="Cumulative change in cost-burdened households by income and tenure"}

cb_income <- cb_7 |> 
  filter(county %in% pha_localities,
         cb_group == "Cost-burdened") |> 
  group_by(year, household_income, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(household_income, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change)) |> 
  ungroup() |> 
  mutate(household_income = fct_relevel(household_income,
                                        "30% AMI or less",
                                        "31 to 50% AMI",
                                        "51 to 80% AMI",
                                        "81 to 100% AMI",
                                        "101% AMI or greater"))

  
ggplot(cb_income,
       aes(x = year, y = run_diff, fill = tenure)) +
  geom_col(position = "dodge") +
  facet_wrap(~household_income, nrow = 1, labeller = label_wrap_gen(width = 18, multi_line = TRUE)) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = "Cumulative change in cost-burdened households by income and tenure",
       subtitle = "2015 to 2018",
       fill = "Tenure",
       caption = "Source: U.S Department of Housing and Urban Development,\nComprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(axis.title = element_blank())
  

```

However, the significant and unexpected drop among cost-burdened renters below 30 percent AMI from 2017 to 2018 deserves further explanation. Because CHAS estimates are only current through 2018, we can use more recent ACS estimates as a comparison. This data is only available by real household income values and not AMI.

The plot below shows the ACS estimates of renter households by cost burden from 2016 to 2020. There is a steady decline in the number of cost-burdened low-income renters (under \$35,000); however, this corresponds to an increasing number of cost-burdened renters with incomes between \$35,000 and \$75,000.

```{r cb-income-acs-data}

# years <- 2015:2020
# 
# pha_geoid <- c("51085", "51760", "51087", "51041")
# 
# b25074_raw <- map_dfr(years, function(yr){
#   b25074_pull <- get_acs(
#     geography = "county",
#     table = "B25074",
#     state = "VA",
#     year = yr
#   ) |> 
#     mutate(year = yr)
# })
# 
# b25074_vars <- load_variables(2020, dataset = "acs5") |> 
#   filter(str_detect(name, "B25074"))
# 
# b25074_vars_cleaned <- b25074_vars |> 
#   separate(label, into = c("est", "tot", "inc", "cb"), sep = "!!") |> 
#   select(variable = name, inc, cb) |> 
#   mutate(across(.fns = ~str_remove_all(.x, ":"))) |> 
#   drop_na() |> 
#   mutate(cb_group = case_when(
#     str_detect(cb, "30.0|35.0|40.0|50.0") ~ "Cost-burdened",
#     str_detect(cb, "20.0|25.0") ~ "Not cost-burdened",
#     TRUE ~ "Not computed"
#   ))
# 
# b25074_data <- b25074_raw |> 
#   filter(GEOID %in% pha_geoid) |> 
#   right_join(b25074_vars_cleaned, by = "variable") |> 
#   filter(!year == 2015) |> 
#   group_by(GEOID, year, inc, cb_group) |> 
#   summarise(estimate = sum(estimate)) |>
#   group_by(GEOID, inc, cb_group) |>
#   mutate(change = estimate - lag(estimate)) |> 
#   ungroup() |> 
#   mutate(inc = fct_relevel(inc,
#                            "Less than $10,000",
#                            "$10,000 to $19,999",
#                            "$20,000 to $34,999",
#                            "$35,000 to $49,999",
#                            "$50,000 to $74,999",
#                            "$75,000 to $99,999",
#                            "$100,000 or more"),
#          cb_group = fct_relevel(cb_group,
#                                 "Cost-burdened",
#                                 "Not cost-burdened",
#                                 "Not computed"))
# 
# write_rds(b25074_data, "data/b25074_data.rds")

```

```{r cb-income-acs-est, fig.cap = "Renter households by income and cost burden"}

b25074_data <- read_rds("data/b25074_data.rds")

ggplot(b25074_data,
       aes(x = year, y = estimate, fill = cb_group)) +
  geom_col(position = "dodge") +
  facet_wrap(~inc, nrow = 1, labeller = label_wrap_gen(width = 12, multi_line = TRUE)) +
  labs(title = "Renter households by income and cost burden",
       subtitle = "2016 to 2020",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B25074.") +
  scale_y_continuous(labels = label_comma()) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5),
        legend.position = "bottom",
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank()) +
  scale_fill_manual(values = c("#d8b365", "#018571", "#80cdc1"))

```

Nearly all cost-burdened renter households have incomes below \$75,000. Filtering for just those estimates, the plot below shows the net annual change from 2016 to 2020. The significant decrease from 2019 to 2020 (1,057) is well beyond the range from previous changes, and may also be due in part to lower ACS response rates among lower-income households during the COVID-19 pandemic.

```{r cb-income-acs-yoy, fig.cap = "Year-over-year change in cost-burdened renter households"}

b25074_yoy <- b25074_data |>
  group_by(year, inc, cb_group) |> 
  filter(cb_group == "Cost-burdened",
         !inc %in% c("$75,000 to $99,999", "$100,000 or more")) |> 
  summarise(sum = sum(estimate)) |> 
  group_by(year) |> 
  summarise(sum = sum(sum)) |> 
  mutate(yoy = sum - lag(sum)) |> 
  drop_na()

ggplot(b25074_yoy,
       aes(x = year, y = yoy, label = label_comma()(yoy))) +
  geom_col(fill = "#d8b365") +
  geom_text(aes(y = yoy - sign(yoy)/0.02,
            label = label_comma()(yoy)),
            color = "white") +
  labs(title = "Year-over-year change in cost-burdened renter households",
       subtitle = "Household income below $75,000 only",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B25074.") +
  scale_y_continuous(labels = label_comma()) +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

  

```

In summary, since the *total* number of renter households in the region has not changed significantly from 2016 to 2020, and because the supply of deeply affordable rental housing has not increased, the estimated decline in low-income cost-burdened renters is likely due to a combination of increasing average incomes "re-sorting" households into higher income categories, as well as pandemic data collection challenges.

### Cost burden by household type

While small families and non-elderly, non-family household saw decreases in cost burden across all four localities, there were significant differences among other household types. There was little decrease in large family housing cost burden in every locality except for Chesterfield County, where there was an increase of 174 households with cost burden. Elderly households saw varying changes in housing cost burden, with the highest increases being in Chesterfield County and Richmond city. Henrico County saw decreases in the number of elderly families experiencing cost burden (-115), but a substantial increase in the number of cost-burdened elderly non-family households (i.e. seniors living alone) (+885) --- the highest increase among all localities.

```{r cb-hh, fig.cap="Change in housing cost burden by household type. Source: Comprehensive Housing Affordability Strategy (CHAS)."}

cb_hh_pha <- cb_7 |> 
  subset(county %in% pha_localities) |> 
  group_by(year, county, household_type, cb_group) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(
    names_from = year,
    values_from = estimate
  ) |> 
  clean_names() |> 
  transform(difference = (x2018 - x2015)) |> 
  filter(cb_group == "Cost-burdened")

cb_hh_bar <- ggplot(cb_hh_pha,
       aes(x = household_type,
           y = difference,
           fill = household_type)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~county) +
  labs(title = "Change in housing cost burden by household type: 2015 to 2018") +
  theme(legend.position = "none",
        axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1))

ggplotly(cb_hh_bar) |> 
  plotly_camera()


```
The causes of the decrease in cost-burdened households across the region is difficult determine with available data. Data is unable to determine if cost-burdened households are simply moving away from the region or if they are no longer experiencing cost burden. Other data metrics may be more appropriate in measuring the impacts of housing costs on households --- including the residual income approach or the National Low Income Housing Coalition's Housing Wage --- but they may not help quantify the number of households impacted by housing costs.

## Mortgage delinquency and foreclosure

Since the Great Recession, mortgage delinquency of 90 days or more has been on a steady decline across the region --- reaching decade's low rates throughout much of 2020 and 2021. Pandemic mortgage relief measures laid out in the CARES Act led to a significant forbearance program, wherein homeowners with federally-backed mortgages could enter into forbearance for a year. The decrease in delinquency can be greatly attributed to these measures which stipulated that loans in forbearance would not be reported as delinquent.

According to some researchers, this program also led to loans in delinquency prior to the pandemic entering into forbearance as well.^[[(Haughwout, Lee, Scally, and van der Klaauw, 2020)](https://libertystreeteconomics.newyorkfed.org/2020/11/following-borrowers-through-forbearance/)] Interestingly, Hanover County saw a spike in mortgage delinquency during 2018, but has since declined to the lowest rate (0.2%) among all localities as of December 2021.


```{r mort-del, fig.cap="Mortgage delinquency rate by locality. Source: Consumer Financial Protection Bureau (CFPB)."}

pha_localities <- c("Richmond city", "Chesterfield County", "Hanover County", "Henrico County")

mort_del <- read_csv("data/mortgage_del.csv") |> 
  pivot_longer(
    cols = starts_with("2"),
    names_to = "period",
    values_to = "estimate"
  )|> 
  mutate(period = ym(period)) |> 
  filter(State == "VA") |> 
  subset(Name %in% pha_localities) |> 
  mutate(estimate = (estimate/100))

mort_del_line <- ggplot(mort_del,
       aes(x = period,
           y = estimate,
           color = Name)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~Name) +
  scale_y_continuous(labels = percent_format()) +
  theme(axis.title = element_blank()) +
  labs(title = "Mortgage delinquency rate by locality: 2008 through 2021", color = "Locality")

ggplotly(mort_del_line) |> 
  plotly_camera()


```
With the moratorium on residential foreclosures having come to an end on June 30, 2022, the region may see increasing mortgage delinquency rates in the coming years.

## Eviction filings and judgements

Richmond's elevation to national prominence due to its eviction rate spurred state-level responses to address the eviction crisis across the Commonwealth. From 2017 to 2019, the region saw small declines in the number of eviction filings. The City of Richmond saw a 14 percent decrease in average annual filings, while eviction judgements only decreased by 8 percent. 

The eviction landscape changed dramatically during the COVID-19 pandemic when the Centers for Disease Control imposed a nationwide federal moratorium on residential evictions in September 2020. In Virginia, Governor Northam requested from the state's Supreme Court a stay on evictions preceding the nationwide moratorium several times. 

```{r evictions, fig.cap="Evictions and filings by locality. Source: RVA Eviction Lab"}

evictions <- read_csv("data/evictions_17_22.csv") |> 
  pivot_longer(3:128,
               names_to = "data",
               values_to = "value") |> 
  mutate(type = case_when(
    str_detect(data, "Filings") ~ "Filings",
    str_detect(data,"Evictions") ~ "Evictions"
  )) |> 
  mutate(date = str_sub(data, -7, -1)) |> 
  mutate(date = ym(date)) |> 
  mutate(year = year(date))

ggplot(evictions,
       aes(x = date,
           y = value,
           fill = type)) +
  geom_col(position = "dodge") +
  facet_wrap(~Jurisdiction) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  labs(title = "Evictions and filings by locality: 2017 through Q3 2022", fill = "Action")

```

These measures led to dramatic decreases in both the number of filings and eviction judgements across the region. However, the eviction moratorium's official end in Virginia on June 30, 2022, brings about concerns among advocates and service providers over a potential wave of evictions and homelessness in the coming months.

In spite of the moratorium, eviction filings and judgements still occurred throughout much of the pandemic. 

```{r evict-avg, fig.cap="Average annual evictions and filings by locality. Source: RVA Eviction Lab"}

eviction_avg <- evictions |> 
  group_by(Jurisdiction, year, type) |> 
  summarise(avg = mean(value))

evict_avg_bar <- ggplot(eviction_avg,
       aes(x = year,
           y = avg,
           fill = type)) +
  geom_col(position = "dodge") +
  facet_wrap(~Jurisdiction) +
  labs(title = "Average annual evictions and filings by locality", fill = "Action") +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank()) +
  scale_x_discrete(limits = c(2017, 2018, 2019, 2020, 2021, 2022))

ggplotly(evict_avg_bar) |> 
  plotly_camera()


```
Eviction filings should continue to be monitored over the coming months. The RVA Eviction Lab has been at the forefront of this data collection and analysis, and will continue to be a resource for the region in understanding the increasing risks for renters with renter protections and resources coming to an end.

## Housing Resource Line

On September 1, 2020, PHA launched the Housing Resource Line to help residents across Central Virginia in need of housing. As of July 2022, the hotline has fielded nearly 15,000 calls from people across the region --- from rural Goochland County to the City of Richmond.

Call volume has remained steady over the near two years that the line has existed; with the call volume not having gone below 500 calls per month since March 2021.

```{r call-vol, fig.cap="PHA Housing Resource Line call volume. Source: Partnership for Housing Affordability."}

call_vol <- read_csv("data/hrl_vol.csv") |> 
  mutate(date = ym(date))

call_vol_bar <- ggplot(call_vol,
       aes(x = date,
           y = volume)) +
  geom_bar(stat = "identity", fill = "red") +
  labs(title = "PHA Housing Resource Line call volume") +
  theme(axis.title = element_blank())

call_vol_bar


# sum(call_vol$volume)
# 
# 14,838

```

The majority of calls (56 percent) were for rental options (36 percent) and financial assistance (20 percent). The two other largest share of calls were for an option not listed (17 percent) and homelessness (13 percent). Unsurprisingly, there is an increase in homelessness calls during the colder months. But PHA staff note that there is an overall increase in calls during the summer months --- specifically in regards to people searching for rental options. This uptick in rental option calls could be directly related to lease non-renewals as landlords sought to increase rents (potentially to recoup losses from the pandemic) and the increasing demand for student rental options ahead of the Fall semester. 

```{r call-topic}

call_top <- read_csv("data/hrl_need.csv") |> 
  mutate(need = case_when(
    need == "Other - specify in \"Issues\" tab" ~ "Other",
    TRUE ~ need
  )) |> 
  transform(percent = ave(vol,FUN = prop.table))

call_top_bar <- ggplot(call_top,
       aes(x = reorder(need, vol), 
           y = percent,
           fill = need)) +
  geom_bar(stat = "identity") + 
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "PHA Housing Resource Line call volume by topic") +
  coord_flip()

ggplotly(call_top_bar) |> 
  plotly_camera()

```

## Homelessness

From 2011 to 2019, the overall count of persons experiencing homelessness across the Greater Richmond Continuum of Care (GRCoC) had been in decline.^[GRCoC covers City of Richmond, and the counties of Charles City, Chesterfield, Goochland, Hanover (including the town of Ashland), Henrico, New Kent, and Powhatan]. But when the COVID-19 pandemic hit, the count jumped --- going from 497 in 2019 to 834 in 2021, a 68 percent increase.

The [Urban Institute recently highlighted](https://www.urban.org/sites/default/files/publication/104529/richmond-virginia-response-to-homelessness-during-the-covid-19-pandemic_0.pdf) Homeward's (the region's planning and coordinating organization for the GRCoC) efforts to address homelessness during the pandemic. Their response measures served as best practice examples in preventing high transmission rates among people experiencing homelessness as well as direct service staff.

But the challenges of reducing homelessness during the pandemic were laid bare. With an eviction moratorium, rental vacancy rates reached record lows --- leaving many seeking rental options with little to none. In addition, providers have also referenced landlords setting high security deposits.

```{r pit, fig.cap="Richmond CoC Point-in-Time count: 2007 to 2021. Source: U.S. Department of Housing and Urban Development (HUD)"}

# years <- as.character(2007:2021)
# 
# path <- "data/2007-2021-PIT-Counts-by-CoC.xlsx"
# 
# full_set <- map_dfr(years, function(yr) {
#   
# 
# pit_set <- read_excel(path, sheet = yr) |> 
#     clean_names()
# 
# suffix_to_remove <- paste0("_", yr)
#   
#   if ("co_c_category" %in% names(pit_set)) {
#     pit_renamed <- pit_set %>%
#       rename_with(~str_remove(.x, suffix_to_remove)) |> 
#       mutate(year = yr) %>%
#       select(co_c_number:co_c_name, co_c_category, type_of_count, year, everything()) |> 
#       mutate(across(-c(co_c_number:year), .fns = as.numeric))
#   } else {
#     pit_renamed <- pit_set %>%
#       rename_with(~str_remove(.x, suffix_to_remove)) |> 
#       mutate(year = yr, co_c_category = NA_character_, 
#              type_of_count = NA_character_) |> 
#       select(co_c_number:co_c_name, co_c_category, type_of_count, year, everything()) |> 
#       mutate(across(-c(co_c_number:year), .fns = as.numeric))
#   }
#   
#   pit_renamed
#   
# })
# 
# full_set_longer <- full_set %>%
#   pivot_longer(
#     cols = overall_homeless:unsheltered_homeless_parenting_youth_under_25_multiple_races, 
#     names_to = "category",
#     values_to = "value"
#   )
# 
# rva_coc <- full_set_longer |> 
#   filter(co_c_number == "VA-500") |> 
#   filter(str_detect(category, "overall_homeless"))
# 
# rva_pit <- rva_coc |> 
#   filter(category == "overall_homeless")
# 
# write_rds(rva_pit, "data/rva_pit.rds")

rva_pit <- read_rds("data/rva_pit.rds")

rva_pit_bar <- ggplot(rva_pit,
       aes(x = year,
           y = value)) +
  geom_bar(stat = "identity", fill = "dark green") +
  labs(title = "Richmond Continuum-of-Care Point-in-Time count") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(big.mark = ","))

ggplotly(rva_pit_bar) |> 
  plotly_camera()


```
The McKinney-Vento Education for Homeless Children and Youth (EHCY) Program collects data on students experiencing homelessness, which often can paint a different picture of homelessness when compared to the Point-in-Time counts. In the region, school divisions have been seeing varying numbers, but between the 2018-2019 and 2019-2020 school years students experiencing homelessness have declined across all school divisions.

The most notable declines in student homelessness have been seen in the Richmond Public School system, where the number of students experiencing homelessness have declined by 40 percent from 2017-2018 to 2019-2020. Given the pandemic and virtual learning environments, more recent McKinney-Vento data may need to be viewed with caution.

```{r mkv}

div <- c(21, 42, 43, 123)

mkv <- read_csv("data/mkv.csv") |> 
  subset(Division %in% div)

mkv_bar <- ggplot(mkv,
       aes(x = year,
           y = students,
           fill = Name)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Name) +
  labs(title = "Enrolled students experiencing homelessness by school year", fill = "School division") +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_y_continuous(labels = number_format(big.mark = ","))

ggplotly(mkv_bar) |> 
  plotly_camera()

```

