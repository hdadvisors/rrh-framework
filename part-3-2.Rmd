# (PART)GAP ANALYSIS {.unnumbered}

## Impact of housing costs on household budgets {#part-3-2}

```{r setup}

library(tidyverse)
library(httr)
library(glue)
library(readxl)
library(janitor)

years <- 2015:2018

sumlev <- "050"

dir.create(glue("data/{sumlev}"))

walk(years, ~{
  
  url <- glue("https://www.huduser.gov/PORTAL/datasets/cp/{.x - 4}thru{.x}-{sumlev}-csv.zip")
  
  file <- basename(url)
  
  path <- file.path("data", sumlev, file)
  
  if (!file.exists(path)) {
    GET(url, write_disk(path, overwrite = TRUE), progress(type = "down"))
  }
  
  print(glue("Unzipping {.x}..."))
  unzip(path, exdir = file.path("data", sumlev, .x))
  
})

years <- 2015:2018

# Tables to get
tables <- c(7, 9, paste0(18, LETTERS[1:3]))

# Go through and write out the various tables
walk(tables, function(table) {
  
  mytable <- purrr::map_df(years, function(year) {
    
    # Identify the year-specific folder
    path <- file.path("data", "050", year)
    
    # Find the file - it may be buried so use recursive = TRUE
    file <- list.files(path, pattern = glue("Table{table}.csv"), recursive = TRUE)
    
    # Read in the file quietly
    raw <- read_csv(file.path(path, file), col_types = cols())
    
    # Clean it up
    cleaned <- raw |> 
      clean_names() |> 
      mutate(fips = substr(geoid, 8, 12)) |> 
      separate(name, into = c("county", "state"), sep = ",") |> 
      filter(st == "51") |> 
      pivot_longer(starts_with("T"), 
                   names_to = "code",
                   values_to = "value") |> 
      mutate(id = str_extract(code, "\\d+$"),
             type = str_extract(code, "est|moe")) |> 
      select(-code) |> 
      pivot_wider(names_from = type, values_from = value) |> 
      rename(Estimate = est, MOE = moe) |> 
      mutate(Code := glue("T{table}_est{id}"),
             Year = year) |> 
      select(Code, Year, Estimate, MOE, everything(), -id) |>       
      mutate(fips = case_when(
        fips == "51515" ~ "51019",
        TRUE ~ fips
      )) |> 
      mutate(county = case_when(
        county == "Bedford city" ~ "Bedford County",
        TRUE ~ county
      )) |> 
      subset(fips %in% rr)
    
    # Account for different data dictionaries
    # Find the data dictionary in the appropriate folder
    dict_path <- list.files(path, pattern = "dictionary", recursive = TRUE, full.names = TRUE) 
    
    # Read in the data dictionary and merge
    dict <- read_excel(dict_path, 
                       sheet = glue("Table {table}"))
    
    cleaned_with_dict <- cleaned %>%
      left_join(dict, by = c("Code" = "Column Name"))
    
    cleaned_with_dict
    
  }) 
  
  file_name <- glue("Table{table}_2012to2018.csv")
  
  message(glue("Writing file {file_name}..."))
  
  write_csv(mytable, glue("data/{file_name}"))
  
})

```
Cost burden
```{r cb-income}



```

```{r cb-tenure}


```

```{r cb-hh}


```

Mortgage delinquency and foreclosure

```{r mort-del}


```


Eviction filings and judgements
```{r evictions}

```

Housing Resource Line
```{r call-vol}

```

```{r call-topic}

```


Homelessness
```{r pit}

```


```{r mkv}

```

