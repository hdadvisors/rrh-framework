# New Kent County {#part-4-5}

This chapter is a summary of the major changes to the New Kent County's population and housing market in the past five years.

```{r setup}

library(tidyverse)
library(tidycensus)
library(sf)
library(sp)
library(plotly)
library(simplevis)
library(tidytext)
library(scales)
library(readxl)
library(zoo)
library(lubridate)
library(janitor)
library(tigris)
library(optiRum)

years <- 2016:2020
fips <- 51127
name <- "New Kent County"
costar_name <- "New Kent County"


```

## Takeaways

```
Add short bullet points summarizing major changes
```

## Demographic and socioeconomic changes

### Population changes


```{r pop}

#Add choice of population stat (net change, components, etc)



pop <- read_rds("data/rr_pop_data.rds") |> 
  mutate(GEOID = parse_number(GEOID)) |> 
  filter(counttype != "Forecast",
         GEOID == fips)

pop_bar <- ggplot(pop,
                      aes(x = year,
                          y = value,
                          fill = value)) +
  geom_col() +
  scale_fill_continuous(viridis_pal()) +
  labs(title = paste0(name, ": Total Population"),
       subtitle = "2010 to 2020",
       caption = "Source: U.S. Census Bureau Decennial Census and American Community Survey") +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank(),
        legend.position = "none")

ggplotly(pop_bar) |> 
  plotly_camera()

```



```{r comp}

change <- read_rds("data/rr_comp_change.rds") |> 
  filter(year == "2010" | year == "2021") |> 
  filter(GEOID == fips)

ggplot(change,
       aes(x = year,
           y = value,
           fill = component)) +
  geom_col(position = "stack") +
  labs(title = paste0(name,": Components of population change"), 
       subtitle = "2010 and 2021",
       fill = "Component of change",
       caption = "Source: U.S. Census Bureau, Population Estimates Program") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(style_positive = "plus", big.mark = ","))


```
### Household characteristics


```{r children}
# Add choice of household stat (HHs with children, HHs with seniors, subfamilies, etc)

b25115_vars <- load_variables(2020, "acs5") |>
  filter(str_sub(name, end = 6) %in% "B25115")
# 
# b25115_raw <- map_dfr(years, function(yr){
#   b25115_pull <- get_acs(
#     geography = "county",
#     state = "VA",
#     table = "B25115",
#     year = yr,
#     survey = "acs5"
#   ) |>
#     mutate(year = yr)
# })
# 
# write_rds(b25115_raw, "data/b25115_raw.rds")

b25115_raw <- read_rds("data/b25115_raw.rds")

b25115_raw <- b25115_raw |>
  subset(GEOID %in% fips)

b25115_vars_cleaned <- b25115_vars |>
  separate(label, into = c("est", "total", "tenure", "family", "type", "rel", "children"), sep = "!!") |>
  select(variable = name, tenure, family, type, rel, children) |>
  mutate(tenure = case_when(
    tenure == "Owner occupied:" ~ "Homeowner",
    tenure == "Renter occupied:" ~ "Renter"
  )) |>
  mutate(family = case_when(
    family == "Family households:" ~ "Family household",
    family == "Nonfamily households" ~ "Nonfamily household"
  )) |>
  mutate(type = case_when(
    type == "Married-couple family:" ~ "Married household",
    rel == "Male householder, no spouse present:" ~ "Single male household",
    rel == "Female householder, no spouse present:" ~ "Single female household",
    family == "Nonfamily household" ~ "Nonfamily household"
  )) |>
  mutate(children = case_when(
    rel == "With own children of the householder under 18 years" ~ "With children",
    rel == "No own children of the householder under 18 years" ~ "No children",
    children == "No own children of the householder under 18 years" ~ "No children",
    children == "With own children of the householder under 18 years" ~ "With children",
    family == "Nonfamily household" ~ "Nonfamily household"
  )) |>
  select(variable, tenure, family, type, children) |>
  drop_na()

b25115 <- b25115_raw |> 
  right_join(b25115_vars_cleaned, by = "variable") |>
  select(NAME, GEOID, year, tenure, type, children, estimate) |> 
  pivot_wider(names_from = year,
              values_from = estimate) |>
  transform(change = `2020` - `2016`) |>
  select(tenure, type, children, change) |>
  group_by(tenure, children) |>
  summarise(change = sum(change))


ggplot(b25115,
       aes(x = children, y = change, fill = tenure)) +
  geom_col(position = "dodge") + 
  facet_wrap(~children, nrow = 1, scales = "free_x") +
  scale_y_continuous(labels = number_format(style_positive = "plus", big.mark = ",")) +
  labs(title = paste0(name, ": Change in households with children by tenure"),
       subtitle = "2016 to 2020",
       fill = "Tenure",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B25115.") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())


```


```{r seniors}

b09020_vars <- load_variables(2020, "acs5") |>
  filter(str_sub(name, end = 6) %in% "B09020")
# 
# b09020_raw <- map_dfr(years, function(yr){
#   b09020_pull <- get_acs(
#     geography = "county",
#     state = "VA",
#     table = "B09020",
#     year = yr,
#     survey = "acs5"
#   ) |>
#     mutate(year = yr)
# })
# 
# write_rds(b09020_raw, "data/b09020_raw.rds")

b09020_raw <- read_rds("data/b09020_raw.rds")

b09020_raw <- b09020_raw |>
  subset(GEOID %in% fips)

b09020_vars_cleaned <- b09020_vars |>
  separate(label, into = c("est", "total", "hhgq", "family", "relationship", "sex", "alone"), sep = "!!") |>
  select(variable = name, hhgq, family, relationship, alone) |>
  filter(!variable %in% c("B09020_001", "B09020_002", "B09020_003", "B09020_005", "B09020_006",
                          "B09020_012", "B09020_013", "B09020_014", "B09020_017")) |>
  mutate(relationship = case_when(
    relationship == "Spouse" ~ "With spouse",
    relationship == "Nonrelatives" ~ "With nonrelatives",
    relationship %in% c("Parent", "Parent-in-law", "Other relatives") ~ "With other relative(s)",
    hhgq == "In group quarters" ~ "Group quarters",
    !is.na(alone) ~ alone,
    TRUE ~ relationship
  )) |>
  mutate(family = case_when(
    family == "In family households:" ~ "Family",
    family == "In nonfamily households:" ~ "Nonfamily",
    hhgq == "In group quarters" ~ "Group quarters"
  )) |>
  mutate(across(.fns = ~str_remove_all(.x, ":"))) |>
  select(1,3,4)

b09020 <- b09020_raw |>
  right_join(b09020_vars_cleaned, by = "variable") |>
  select(NAME, GEOID, year, family, relationship, estimate) |>
  mutate(NAME = str_remove_all(NAME, ", Virginia")) |>
  group_by(year, family, relationship) |>
  summarise(estimate = sum(estimate)) |>
  group_by(family, relationship) |>
  mutate(diff = estimate - lag(estimate)) |>
  drop_na() |>
  mutate(run_diff = cumsum(diff))


b09020 <- b09020 |> 
  ungroup() |> 
  filter(year == 2020) |> 
  mutate(family = str_replace(family, "Group quarters", " "),
         family = fct_relevel(family, "Family", "Nonfamily", " "))

seniors <- ggplot(b09020,
       aes(y = reorder_within(relationship, run_diff, family),
           x = run_diff,
           fill = relationship)) +
  geom_col(position = "dodge") +
  scale_y_reordered() +
  scale_x_continuous(labels = label_comma(),
                     breaks = c(0,2000,4000,6000,8000)) +
  facet_grid(rows = vars(family), scales = "free_y", space = "free", switch = "y") +
  #scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +
  labs(title = paste0(name, ": Change in senior population by living arrangement",
       subtitle="2016 to 2020",
       fill="Tenure",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B09020.") +
  theme(axis.title = element_blank(),
        #axis.text.x = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "none",
        panel.grid.major.x = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(angle = 0))


```

### Income and wages

```{r income}

#Add choice of income stat (probably median household income of some kind)

# years <- 2016:2020
# 
# b25119_vars <- load_variables(2020, "acs5") |> 
#   filter(str_sub(name, end = 6) %in% "B25119")
# 
# b25119_raw <- map_dfr(years, function(yr){
#   b25119_pull <- get_acs(
#     geography = "county",
#     state = "VA",
#     table = "B25119",
#     year = yr,
#     survey = "acs5",
#     cache_table = TRUE
#   ) %>%
#     mutate(year = yr)
#   })
# 
# write_rds(b25119_raw, "data/b25119_raw.rds")

b25119_raw <- read_rds("data/b25119_raw.rds")

b25119_raw <- b25119_raw |> 
  subset(GEOID %in% fips)

b25119_vars_cleaned <- b25119_vars |> 
  separate(label, into = c("est", "income", "total", "tenure"), sep = "!!") |>  
  select(variable = name, tenure) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied (dollars)" ~ "Homeowner",
    tenure == "Renter occupied (dollars)" ~ "Renter"
  ))

b25119_vars_cleaned$tenure <- b25119_vars_cleaned$tenure |>  replace_na('All households')

b25119 <- b25119_raw |> 
  right_join(b25119_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, estimate, moe)

cpi <- read_excel("data/CPI_U_RS.xlsx")
cpi <- cpi |> 
  rename(year = Year,
         priceindex = Index) |> 
  transform(year = as.numeric(year))

b25119_cpi <- b25119 |> 
    left_join(cpi, by = 'year') |> 
  transform(dollars20 = ((381.2/priceindex)*estimate)) |> 
  select(NAME, GEOID, year, tenure, dollars20, cdollars = estimate) |> 
  separate(NAME, into = c("locality", "state"), sep = ",") |> 
  filter(tenure != "All households") |> 
  select(year, locality, tenure, dollars20)

ggplot(b25119_cpi, 
       aes(x = year,
           y = dollars20,
           color = tenure)) +
  geom_line(stat = "identity", size = 1) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format()) +
  labs(title = paste0(name, ": Median houshold income by tenure"), 
       color = "Tenure",
       subtitle = "2016 to 2020 |Adjusted to 2020 dollars",
       caption = "Source: U.S. Census Bureau, American Community Survey")

# 16 percent increase for renters
# 10 percent increase for homeowners

```


### Persons with disabilities

Independent living difficulties make it necessary for many individuals to seek assisted living facilities or significant modifications to their home to continue to live comfortably. However, both options can be costly --- increasing the need for funding of home accessibility rehabilitation or new accessible housing construction.


```{r ind-living}

# Add disability stat (probably independent living difficulty)

# Table B18107 Sex by age by independent living difficulty

# "Because of a physical, mental, or emotional problem, having difficulty doing errands alone such as visiting a doctorâ€™s office or shopping (DOUT)."


b18107_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B18107")

b18107_raw <- map_dfr(years, function(yr){
  b10107_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B18107",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
  })

b18107_raw <- b18107_raw |> 
  subset(GEOID %in% fips)

b18107_vars_cleaned <- b18107_vars |> 
  separate(label, into = c("est", "total", "sex", "age", "indliv"), sep = "!!") |> 
  select(variable = name, sex , age, indliv) |> 
  drop_na() |> 
  mutate(across(.fns = ~str_remove_all(.x, ":")))

b18107 <- b18107_raw |> 
  right_join(b18107_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, sex, age, indliv, estimate) |> 
  group_by(year, age, indliv) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(indliv == "With an independent living difficulty") |> 
  pivot_wider(names_from = year,
              values_from =  estimate) |> 
  transform(change = `2020` - `2016`) |> 
  select(age, indliv, change)

ggplot(b18107,
       aes(x = age,
           y = change,
           )) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  scale_y_continuous(labels = number_format(style_positive = "plus", big.mark = ",")) +
  theme(axis.title = element_blank()) +
  labs(title = paste0(name, ": Change in population with independent living difficulty by age"),
       subtitle = "2016 to 2020")

```

## Housing supply and market changes

### Homeownership


```{r sales}

# Median sales price over time 
# Charles City had low sales numbers and this may not be representative

price <- read_csv("data/newkent_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = name) |> 
  pivot_longer(cols = starts_with("sale"),
    names_to = "label",
    values_to = "med_price",
    values_drop_na = TRUE) |> 
  mutate(year = substr(label, 19,23)) |> 
  select(geography, year, month, med_price)

price$month <- match(price$month, month.abb)

price <- price |> 
  mutate(date = make_date(year, month)) |> 
  mutate(med_price = parse_number(med_price))

ggplot(price,
       aes(x = date,
           y = med_price,
           color = med_price)) +
  geom_line(stat = "identity", size = 1) +
  scale_y_continuous(labels = dollar_format()) +
  labs(title = paste0(name, ": Median home sales price"),
       color = "Median price",
       caption = "Source: Central Virginia Regional Multiple Listing Service") +
  theme(axis.title = element_blank()) +
  scale_color_continuous(type = "viridis", label = dollar_format())


```

### Rental


```{r rent-submarket}

# Average asking rent over time (by submarket if applicable, maybe by bedroom if no submarkets)

# Disaggregate by Richmond CoStar Submarket

# CoStar Filters: Construction Status - Existing

# Added locality field manually

sub_rent <- read_csv("data/rr_submarket_data.csv") |> 
  clean_names() |> 
  separate(geography, into = c("region", "state", "submarket"), sep = " - ") |> 
  select(period, locality, submarket, "rent" = market_asking_rent_unit, vacancy_rate) |> 
  mutate(rent = parse_number(rent)) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  filter(locality == costar_name)

# Issue with above is that rents are not inflation-adjusted. May need to revisit. I've requested from CoStar to allow for an inflation-adjusted average rent per unit pull, BUT who knows if they can add it. Might consider just having a table with most recent rents.

sub_rent_line <- ggplot(sub_rent,
       aes(x = period,
           y = rent, 
           color = submarket)) +
  geom_line(stat = "identity") + 
  labs(title = paste0(name, ": Average asking rent by submarket"))
  

ggplotly(sub_rent_line)

```


### Housing assistance

```
Change in number of assisted units (NHPD)
```

### Naturally-occuring affordable housing

```{r noah}
# Add choice of NOAH stat (total number, change in rent, etc) 

# Probably do a histogram by age

rva_noah <- read_csv("data/pha_noah_81722.csv") |> 
  clean_names() |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE) |> 
  filter(property_name != "Sedgefield" | property_name != "Holidy Mobile Home Park") |> 
  filter(county_name == costar_name)




```

## Gap analysis


```{r rva-rent-gap}

# Compare local median renter income to average asking rent

b25119_cpi <- read_rds("data/b25119_cpi_rr.rds")

income <- b25119_cpi |> 
  filter(locality == name) |> 
  filter(tenure == "Renter")

rent <- read_csv("data/rr_annual_rent.csv") |> 
    pivot_longer(cols = 2:8,
               names_to = "locality",
               values_to = "rent_current") |> 
  clean_names() |> 
  filter(locality == costar_name)


rent_gap <- income |> 
  left_join(rent, by = "year") |> 
  mutate(rent_current = parse_number(rent_current)) |> 
  mutate(affordable_rent = (cdollars/12)*.30) |> 
  mutate(difference = rent_current - affordable_rent) |> 
  select(year, rent_current, affordable_rent) |> 
  pivot_longer(2:3,
               names_to = "type",
               values_to = "dollars")

rent_gp <- ggplot(rent_gap,
       aes(x = year,
           y = dollars,
           color = type)) +
  geom_line(stat = "identity", size = 1) +
  scale_y_continuous(labels = dollar_format()) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
  labs(title = paste0(name, ": Average asking rent versus rent affordable to typical renter", color = "Nominal rent"))
       
  
ggplotly(rent_gp) |> 
  plotly_camera()

```


```{r  own-gap}

# Compare local renter income versus local home prices

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names() |> 
  filter(locality == costar_name)

int_annual <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
utilities <- 250 # Assume $250/month for utilities

sale <- rr_sales_annual |> 
  left_join(income, by = "year") |> 
  left_join(int_annual, by = "year") |> 
  drop_na() |> 
  mutate(principal = price - (price*downpayment)) |> 
  mutate(loanamt = principal/(1-closingcosts)) |> 
  mutate(mortgage = abs(PMT((annual_int/12), 360, loanamt)) + 250) |> 
  mutate(inc_needed = ((mortgage*10)/2.8)*12) |> 
  select(year, inc_needed, cdollars)

slgap <- sale |> 
  pivot_longer(2:3,
               names_to = "data",
               values_to = "value") |> 
  mutate(data = case_when(
    data == "cdollars" ~ "Renter median household income",
    data == "inc_needed" ~ "Income needed to afford median home price"
  ))

sale_gp <- ggplot(slgap,
       aes(x = year, 
           y = value,
           color = data)) +
  geom_line(stat = "identity", size = 1) +
  labs(title = paste0(name, ": Income needed to afford median home price versus median renter income", color = "Nominal dollars")) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format())

ggplotly(sale_gp) |> 
  plotly_camera()

```
...

### Affordability of current housing stock

```{r gap}
# Add choice of affordability stat (surplus/deficit, income vs prices, etc)

gap <- read_rds("data/tb_18_match.rds") |> 
  filter(county == name) |> 
  group_by(year, household_income, gapcode) |>
  summarise(estimate = sum(estimate)) |>
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |>
  filter(household_income != "80 percent AMI or greater")

gap_bar <- ggplot(gap,
       aes(x = year, 
           y = estimate,
           fill = gapcode)) +
  geom_bar(stat = "identity") +
  facet_grid(~household_income) +
  theme(axis.title = element_blank()) +
  labs(title = paste0(name, ": Rental housing gap by AMI: 2015 to 2018"), fill = "Gap/Affordability")

ggplotly(gap_bar) |> 
  plotly_camera()

```

### Impact of housing costs


```{r cb}

cb_7 <- read_rds("data/cb_7.rds")

cb <- cb_7 |> 
  filter(county == name,
         cb_group == "Cost-burdened") |> 
  group_by(year, county, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change))
  
ggplot(cb,
       aes(x = year, y = run_diff, fill = tenure)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(county)) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Cumulative change in cost-burdened households by tenure"),
       subtitle = "2015 to 2018",
       fill = "Tenure",
       caption = "Source: U.S Department of Housing and Urban Development,\nComprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(axis.title = element_blank())


```

```{r mkv, fig.cap="Enrolled students experiencing homelessness by school year"}

div <- 63

mkv <- read_csv("data/mkv.csv") |> 
  subset(Division %in% div)

ggplot(mkv,
       aes(x = year,
           y = students,
           fill = Name)) +
  geom_bar(stat = "identity") +
  facet_wrap(~Name) +
  labs(title = "Enrolled students experiencing homelessness by school year",
       subtitle = "2016-2017 to 2019-2020",
       caption = "William & Mary School of Education, Project HOME - Virginia.") +
  theme(axis.title = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank()) +
  scale_y_continuous(labels = label_comma())

```
