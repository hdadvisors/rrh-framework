# (PART)Housing supply and market changes {.unnumbered}

## Homeownership characteristics{#part-2-1}

```{r setup}

library(tidyverse)
library(tidycensus)
library(janitor)
library(glue)
library(stringi)
library(zoo)
library(lubridate)
library(tigris)
library(ggthemes)
library(scales)
library(plotly)
library(simplevis)

# rr includes Charles City, Goochland, New Kent, and Powhatan.

rr <- c("51085", "51760", "51075", "51145", "51087", "51127", "51036", "51041")
pha <- c("51085", "51760", "51087", "51041")

pha_names <- c("Richmond city", "Henrico County", "Hanover County", "Chesterfield County")

```

### Homeownership housing stock

The stock of homeowner housing has been growing across the region. From 2016 to 2020, owner-occupied housing has increased by 17,436 --- an increase of seven percent. Unsurprisingly, much of that growth (93 percent) has occurred in the single-family home market, including detached and attached homes. The largest share of that single-family home growth has occurred in Chesterfield County, where there was a net gain of 7,184 single-family homeowners.
```{r oo-structure}

# Table B25127 Tenure by year structure built by units in structure

years <- 2016:2020

b25127_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25127")

b25127_raw <- map_dfr(years, function(yr){
  b25127_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25127",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
})

b25127_raw <- b25127_raw |> 
  subset(GEOID %in% pha)

b25127_vars_cleaned <- b25127_vars |> 
  separate(label, into = c("est", "total", "tenure", "yrbuilt", "structure"), sep = "!!") |> 
  select(variable = name, tenure, yrbuilt, structure) |> 
  drop_na() |> 
  mutate(across(.fns = ~str_remove_all(.x, ":"))) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied" ~ "Homeowner",
    tenure == "Renter occupied" ~ "Renter"
  ))

b25127_data <- b25127_raw |> 
  right_join(b25127_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, yrbuilt, structure, estimate)

oo_structure <- b25127_data |> 
  filter(tenure == "Homeowner") |> 
  select(NAME, GEOID, year, structure, estimate) |> 
  group_by(NAME, GEOID, year, structure) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(
    names_from = year,
    values_from = estimate
  ) |> 
  mutate(difference = `2020` - `2016`) |> 
  mutate(pchange = difference/`2016`) |> 
  separate(NAME, into = c("county", "state"), sep = ",")  |> 
  mutate(structure = case_when(
    structure == "20 to 49" ~ "20 or more",
    structure == "50 or more" ~ "20 or more",
    TRUE ~ structure
  ))

structure_bar <- ggplot(oo_structure,
       aes(x = reorder(structure, -difference), 
           y = difference,
           fill = structure)) +
  geom_bar(stat = "identity") +
  facet_wrap(~county) + 
  labs(title = "Change in homeowner housing by structure type", subtitle = "From 2016 to 2020", fill = "Structure type") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        legend.justification = "top")

ggplotly(structure_bar) |> 
  plotly_camera()

```

The vast majority of homeowner housing in the region was constructed in the latter half of the 20th century. The amount of housing structured in the 2000s pales in comparison to the housing built between 1980 and 1999. With so much owner-occupied housing beyond twenty years of age, homeowners will increasingly need resources to maintain their homes, or brand new housing stock to move into.

```{r oo-year-built}

oo_yrblt <- b25127_data |> 
  filter(tenure == "Homeowner") |> 
  filter(year == 2020) |> 
  select(NAME, GEOID, year, yrbuilt, estimate) |> 
  group_by(NAME, GEOID, year, yrbuilt) |> 
  summarise(estimate = sum(estimate)) |> 
  mutate(yrbuilt = case_when(
    yrbuilt == "Built 1940 to 1959" ~ "Built 1940 to 1979",
    yrbuilt == "Built 1960 to 1979" ~ "Built 1940 to 1979",
    TRUE ~ yrbuilt
  )) |> 
  separate(NAME, into = c("county", "state"), sep = ",") |> 
  group_by(county, GEOID, year, yrbuilt) |> 
  summarise(estimate = sum(estimate))
  
yrblt <- ggplot(oo_yrblt,
       aes(x = yrbuilt,
           y = estimate,
           fill = yrbuilt
           )) + 
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~county) +
  labs(title = "Owner-occupied housing by year built", subtitle = "Total housing units in 2020") +
  theme(axis.title.x = element_blank(), 
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        legend.justification = "top")

plotly::ggplotly(yrblt) |> 
  plotly_camera()

```

```{r oo-bedrooms}

years <- 2016:2020

b25042_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25042")

b25042_raw <- map_dfr(years, function(yr) {
  b25042_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25042",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
})

b25042_raw <- b25042_raw |> 
  subset(GEOID %in% pha)

b25042_vars_cleaned <- b25042_vars |> 
  separate(label, into = c("est", "total", "tenure", "br"), sep = "!!") |> 
  select(variable = name, tenure, br) |> 
  drop_na() |> 
  mutate(across(.fns = ~str_remove_all(.x, ":"))) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied" ~ "Homeowner",
    tenure == "Renter occupied" ~ "Renter"
  ))

b25042_data <- b25042_raw |> 
  right_join(b25042_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, br, estimate)

oo_br <- b25042_data |> 
  filter(tenure == "Homeowner") |> 
  mutate(br = case_when(
    br == "1 bedroom" ~ "1-2 bedrooms", 
    br == "2 bedrooms" ~ "1-2 bedrooms",
    br == "3 bedrooms" ~ "3-4 bedrooms",
    br == "4 bedrooms" ~ "3-4 bedrooms",
    TRUE ~ br
  )) |> 
  group_by(NAME, GEOID, year, br) |> 
  summarise(estimate = sum(estimate)) |> 
  mutate(percent = estimate/sum(estimate)) |> 
  ungroup() |> 
  separate(NAME, into = c("county", "state"), sep = ",") |> 
  filter(year == 2020 | year == 2016)

br_bar <- ggplot(oo_br,
       aes(x = county,
           y = percent, 
           fill = br)) +
  geom_bar(position = "stack", stat = "identity") + 
  scale_fill_discrete(breaks = c("No bedroom", "1-2 bedrooms", "3-4 bedrooms", "5 or more bedrooms")) +
  labs(title = "Homeowner housing by bedrooms", fill = "Bedrooms") + 
  scale_y_continuous(labels = scales::percent) +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90)) +
  facet_wrap(~year)

plotly::ggplotly(br_bar) |> 
  plotly_camera()


```

### For-sale market

In all nearly all localities except for Chesterfield County, the average number of home sales has largely remained the same. Only in Chesterfield County was there a more than 10 percent increase in average monthly home sales between 2019 and 2021. In fact there was a 15 percent increase in home sales in Chesterfield County. 

```{r n-sales}

# Pull in MLS data csv for each county from 2017 to 2022 by month for four major localities by month as of July 11, 2022.

# CVR MLS Filter: Property type - Single Family, Condo/Town

# Data Pull: Time Frame - Past 5 Years; Statistic = Sales, Number of; Group By - Month

chesterfield_sales <- read_csv("data/chesterfield_num_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Chesterfield County")

hanover_sales <- read_csv("data/hanover_num_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Hanover County")

henrico_sales <- read_csv("data/henrico_num_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Henrico County")

richmond_sales <- read_csv("data/richmond_num_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Richmond City")

pha <- list(chesterfield_sales, hanover_sales, henrico_sales, richmond_sales)

clean_data <- function(df){
  df |> pivot_longer(cols = starts_with("sales"),
    names_to = "label",
    values_to = "sales",
    values_drop_na = TRUE
  ) |> 
mutate(year = substr(label, 17,20))
}

pha_sales <- map_dfr(pha, clean_data) |> 
  select(geography, year, month, sales)

pha_sales$month <- match(pha_sales$month, month.abb)

pha_sales <- pha_sales |> 
  mutate(date = make_date(year, month)) 

n_sales <- ggplot(pha_sales,
       aes(x = date, y = sales, fill = geography)) +
  geom_bar(stat = "identity") +
  facet_wrap(~geography) +
  labs(title = "Home sales in the Richmond Region", subtitle = "Homes sales by quarter from 2017 to 2022", fill = "Locality")

plotly::ggplotly(n_sales) |> 
  plotly_camera()

```

```{r avg-sales}

avg_sales <- pha_sales |> 
  group_by(year, geography) |> 
  summarise(average = mean(sales)) |> 
  filter(year != 2022)

a_sales <- ggplot(avg_sales,
       aes(x = year, y = average, fill = geography)) +
  geom_bar(stat = "identity") +
  facet_wrap(~geography) +
  labs(title = "Average monthly home sales in the Richmond Region", colour = "Locality")

plotly::ggplotly(a_sales) |> 
  plotly_camera()

```

Median home prices have continued to climb in the Richmond Region --- reaching over \$300,000 in all four major localities. 

```{r sales-price}

# Pull in MLS data csv for each county from 2017 to 2022 by month for four major localities by month.

# CVR MLS Filter: Property type - Single Family, Condo/Town

# Data Pull: Time Frame - Past 5 Years; Statistic = Sales Price, Median; Group By - Month

# Median sales price by month

chesterfield_price <- read_csv("data/chesterfield_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Chesterfield County")

hanover_price <- read_csv("data/hanover_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Hanover County")

henrico_price <- read_csv("data/henrico_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Henrico County")

richmond_price <- read_csv("data/richmond_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = "Richmond City")

pha_price <- list(chesterfield_price, hanover_price, henrico_price, richmond_price)

clean_data <- function(df){
  df |> pivot_longer(cols = starts_with("sale"),
    names_to = "label",
    values_to = "med_price",
    values_drop_na = TRUE
  ) |> 
mutate(year = substr(label, 19,23))
}

pha_price <- map_dfr(pha_price, clean_data) |> 
  select(geography, year, month, med_price)

pha_price$month <- match(pha_price$month, month.abb)

pha_price <- pha_price |> 
  mutate(date = make_date(year, month)) |> 
  mutate(med_price = parse_number(med_price))

price_line <- ggplot(pha_price,
       aes(x = date,
           y = med_price,
           colour = geography)) +
  geom_line(stat = "identity") +
  facet_wrap(~geography) +
  scale_y_continuous(labels = dollar_format())

plotly::ggplotly(price_line) |> 
  plotly_camera()


# CHESTERFIELD - $237,398 TO $380,000

```

```{r dom}

# Pull in MLS data csv for each county from 2017 to 2022 by quarter?

# Average days on market by quarter

```

```{r supply}

# Pull in MLS data csv for just the region.

# Months supply by quarter

pha_supply <- read_csv("data/pha_mos_supply.csv")

pha_supply <- pha_supply|> 
  pivot_longer(cols = starts_with("Months"),
    names_to = "label",
    values_to = "months_sup",
    values_drop_na = TRUE) |> 
  mutate(year = substr(label, 21,24))

pha_supply$Month <- match(pha_supply$Month, month.abb)

pha_supply <- pha_supply |> 
  mutate(date = make_date(year, Month)) |> 
  select(date, months_sup)

supply_bar <- ggplot(pha_supply,
                     aes(x = date, 
                         y = months_sup)) +
  geom_bar(stat = "identity", fill = "dark green") +
  labs(title = "Months supply of for-sale housing by quarter") +
  theme(axis.title = element_blank())

ggplotly(supply_bar) |> 
  plotly_camera()

```
#### Starter homes

```{r starter-homes}

# Utilizing data pulled by VAR for HB854; does not have data for 2022 

st_homes <- read_csv("data/var_starterhomes.csv") |> 
  subset(County_Name %in% pha_names) |> 
  mutate(FY = as.character(FY))

starter_share <- ggplot(st_homes, 
         aes(x = FY,
           y = starter_homes_pct,
           fill = County_Name)) +
  geom_bar(stat = "identity") + 
  facet_wrap(~County_Name) +
  scale_y_continuous(labels = percent_format())  +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = .1, hjust = 1)) +
  labs(title = "Share of starter homes sold", fill = "Locality")

ggplotly(starter_share) |> 
  plotly_camera()

```

#### New construction versus re-sale

On average, there is a \$89,127 difference between new construction and resale sales price.

```{r comp-price, fig.cap= "Sales price comparison: new construction versus resale"}

newconstruction_price <- read_csv("data/pha_price_new.csv") |> 
  clean_names() |> 
  mutate(type = "New Construction")

resale_price <- read_csv("data/pha_price_resale.csv") |> 
  clean_names() |> 
  mutate(type = "Resale")

pha_comp <- list(newconstruction_price, resale_price)

clean_data <- function(df){
  df |> pivot_longer(cols = starts_with("sale"),
    names_to = "label",
    values_to = "med_price",
    values_drop_na = TRUE
  ) |> 
mutate(year = substr(label, 19,23))
}

pha_comp <- map_dfr(pha_comp, clean_data) |> 
  select(type, year, month, med_price)

pha_comp$month <- match(pha_comp$month, month.abb)

pha_price_comp <- pha_comp |> 
  mutate(date = make_date(year, month)) |> 
  mutate(med_price = parse_number(med_price)) |> 
  filter(year == "2020" | year == "2021" | year == "2022")

ggplot(pha_price_comp,
       aes(x = date, y = med_price, fill = type)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "Sales price comparison: new construction versus resale", fill = "Construction Type") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        legend.position = "none") +
  scale_y_continuous(labels = dollar_format()) +
  facet_grid(~type)

# pha_price_comp_long <- pha_price_comp |> 
#   pivot_wider(names_from = type,
#               values_from = med_price) |> 
#   clean_names() |> 
#   mutate(difference = (new_construction-resale))
# 
# mean(pha_price_comp_long$difference)
# 89127.67

```

```{r comp-br}

# New construction versus Resale by bedrooms - total sales 
# 1-2 bedroom // 3-4 bedroom // 5 + bedroom
# As of 7.27.22

nc_2br <- read_csv("data/pha_nc_2br.csv") |> 
  mutate(type = "New Construction") |> 
  mutate(br = "1-2 bedroom")

nc_4br <- read_csv("data/pha_nc_4br.csv") |> 
  mutate(type = "New Construction")|> 
  mutate(br = "3-4 bedroom")

nc_5br <- read_csv("data/pha_nc_5br.csv") |> 
  mutate(type = "New Construction")|> 
  mutate(br = "5+ bedroom")

re_2br <- read_csv("data/pha_re_2br.csv") |> 
  mutate(type = "Resale")|> 
  mutate(br = "1-2 bedroom")

re_4br <- read_csv("data/pha_re_4br.csv") |> 
  mutate(type = "Resale")|> 
  mutate(br = "3-4 bedroom")

re_5br <- read_csv("data/pha_re_5br.csv") |> 
  mutate(type = "Resale")|> 
  mutate(br = "5+ bedroom")


pha_br <- list(nc_2br, nc_4br, nc_5br, re_2br, re_4br, re_5br)

pha_br_clean <- function(df){
  df |> pivot_longer(cols = starts_with("sales"),
    names_to = "label",
    values_to = "sales",
    values_drop_na = TRUE
  ) |> 
mutate(year = substr(label, 17,21))
}

pha_br_comp <- map_dfr(pha_br, pha_br_clean ) |> 
  select(type, br, year, Month, sales)

pha_br_comp$Month <- match(pha_br_comp$Month, month.abb)

pha_br_comp <- pha_br_comp |> 
  mutate(date = make_date(year, Month)) |> 
  group_by(year, br, type) |> 
  summarise(sales = sum(sales)) |> 
  mutate(percent = sales/sum(sales))

ggplot(pha_br_comp,
       aes(x = year, y = percent, fill = type)) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~br) +
  labs(title = "Sales comparison by bedrooms: New Construction versus Resale", fill = "Construction Type") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.2),
        axis.ticks.x = element_blank()) + 
  scale_y_continuous(labels = percent_format())
  


```


```{r comp-sf}

# New construction versus Resale by SF // Total sales
# Less than 1000 SF // 1000-1999 SF // 2000-2999 SF / 3000 + SF
# As of 7.27.22

nc_999 <- read_csv("data/pha_nc_999sf.csv") |> 
  mutate(type = "New Construction") |> 
  mutate(sf = "Less than 1,000 SF")

nc_1999 <- read_csv("data/pha_nc_1999sf.csv") |> 
  mutate(type = "New Construction")|> 
  mutate(sf = "1,000-1,999 SF")

nc_2999 <- read_csv("data/pha_nc_2999sf.csv") |> 
  mutate(type = "New Construction")|> 
  mutate(sf = "2,000-2,999 SF")

nc_3000 <- read_csv("data/pha_nc_3000sf.csv") |> 
  mutate(type = "New Construction")|> 
  mutate(sf = "3,000+ SF")

re_999 <- read_csv("data/pha_re_999sf.csv") |> 
  mutate(type = "Resale") |> 
  mutate(sf = "Less than 1,000 SF")

re_1999 <- read_csv("data/pha_re_1999sf.csv") |> 
  mutate(type = "Resale")|> 
  mutate(sf = "1,000-1,999 SF")

re_2999 <- read_csv("data/pha_re_2999sf.csv") |> 
  mutate(type = "Resale")|> 
  mutate(sf = "2,000-2,999 SF")

re_3000 <- read_csv("data/pha_re_3000sf.csv") |> 
  mutate(type = "Resale")|> 
  mutate(sf = "3,000+ SF")


pha_sf <- list(nc_999, nc_1999, nc_2999, nc_3000, re_999, re_1999, re_2999, re_3000)

pha_sf_clean <- function(df){
  df |> pivot_longer(cols = starts_with("sales"),
    names_to = "label",
    values_to = "sales",
    values_drop_na = TRUE
  ) |> 
mutate(year = substr(label, 17,21))
}

pha_sf_comp <- map_dfr(pha_sf, pha_sf_clean ) |> 
  select(type, sf, year, Month, sales)

pha_sf_comp$Month <- match(pha_sf_comp$Month, month.abb)

pha_sf_comp <- pha_sf_comp |> 
  mutate(date = make_date(year, Month)) |> 
  group_by(year, type, sf) |> 
  summarise(sales = sum(sales)) |> 
  mutate(percent = sales/sum(sales))
  

ggplot(pha_sf_comp,
       aes(x = year, y = percent, fill = factor(sf, levels = c("Less than 1,000 SF", "1,000-1,999 SF", "2,000-2,999 SF", "3,000+ SF")))) +
  geom_bar(stat = "identity", position = "stack") +
  facet_wrap(~type) +
  labs(title = "Sales comparison by square footage: New Construction versus Resale", fill = "Construction Type") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())


```


### Construction trends

```{r sf-construction}

years <- 2000:2020

header_rows <- read_csv("https://www2.census.gov/econ/bps/County/co2020a.txt", 
                        col_names = FALSE,
                        n_max = 2)

column_names <- header_rows %>%
  select(X1:X18) %>%
  t() %>%
  as_tibble() %>%
  mutate(group = rep(1:6, each = 3)) %>%
  group_by(group) %>%
  fill(V1, .direction = "updown") %>%
  mutate(names = paste0(V1, ": ", V2)) %>%
  pull(names)

cbps_raw <- map_df(years, ~{
  raw <- read_csv(glue("https://www2.census.gov/econ/bps/County/co{.x}a.txt"), skip = 2, 
                    col_names = FALSE) %>%
    select(X1:X18) %>%
    set_names(column_names)
  
  raw
  
})

cbps_data <- cbps_raw %>% 
  mutate(year = `Survey: Date`,
         GEOID = paste0(`FIPS: State`, `FIPS: County`)) %>%
  select(`1-unit: Bldgs`:GEOID) %>%
  subset(GEOID %in% rr) %>%
  pivot_longer(`1-unit: Bldgs`:`5+ units: Value`,
               names_to = "type",
               values_to = "value") %>%
  separate(type, into = c("Type", "col"), sep = ": ") %>%
  pivot_wider(names_from = col,
              values_from = value) %>%
  rename_with(tolower, Type:Value) %>% 
  select(GEOID, year, type:units)

rr_cbps <- cbps_data |> 
  right_join(rr_va, by = "GEOID") |> 
  select(GEOID, NAME, year, type:units)

pha_cbps <- rr_cbps |> 
  subset(GEOID %in% pha) |> 
  filter(type == "1-unit")

ggplot(pha_cbps,
       aes(x = year, y = units, colour = NAME)) +
  geom_line(stat = "identity") +
  facet_wrap(~NAME) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title = "Single-family building permits")

```


### Homeownership rate

```{r ho-rate}

years <- 2010:2020

b25003_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 7) %in% "B25003_")

b25003_raw <- map_dfr(years, function(yr){
   b25003_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25003",
    year = yr,
    survey = "acs5"
  ) |> 
    mutate(year = yr)
})

b25003_raw <- b25003_raw |> 
  subset(GEOID %in% pha)

b25003_vars_cleaned <- b25003_vars |> 
  separate(label, into = c("est", "total", "tenure"), sep = "!!") |> 
  select(variable = name, tenure) |> 
  mutate(across(.fns = ~str_replace_na(.x, "All households"))) |>  mutate(tenure = case_when(
    tenure == "Owner occupied" ~ "Homeowner",
    tenure == "Renter occupied" ~ "Renter",
    TRUE ~ tenure
  ))

b25003_data <- b25003_raw |> 
  right_join(b25003_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, estimate)

pha_homeownership <- b25003_data |> 
  pivot_wider(
    names_from = tenure,
    values_from = estimate
  ) |> 
  mutate(ho_rate = (Homeowner/`All households`))  |> 
  separate(NAME, into = c("county", "state"), sep = ",")

ggplot(pha_homeownership,
       aes(x = year, 
           y = ho_rate, 
           color = county)) +
  geom_line(stat = "identity", size = 1) + 
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Homeownership rate by locality: 2010 to 2020", color = "Locality") +
  theme(axis.title = element_blank()) +
  scale_x_continuous(breaks = c(2010, 2015, 2020))
  

```

```{r ho-age}

years <- 2016:2020

b25007_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25007")

b25007_raw <- map_dfr(years, function(yr){
   b25007_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25007",
    year = yr,
    survey = "acs5"
  ) |> 
    mutate(year = yr)
})

b25007_raw <- b25007_raw |> 
  subset(GEOID %in% pha)

b25007_vars_cleaned <- b25007_vars |> 
  separate(label, into = c("est", "total", "tenure", "age"), sep = "!!") |> 
  select(variable = name, tenure, age) |> 
  mutate(across(.fns = ~str_remove_all(.x, ":")),
         across(.fns = ~str_remove_all(.x,"Householder "))) |>  
  mutate(tenure = case_when(
    tenure == "Owner occupied" ~ "Homeowner",
    tenure == "Renter occupied" ~ "Renter",
    TRUE ~ tenure
  )) |> 
    drop_na()

b25007_data <- b25007_raw |> 
  right_join(b25007_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, age, estimate) |> 
  mutate(age = case_when(
    age == "25 to 34 years" ~ "25 to 44 years",
    age == "35 to 44 years" ~ "25 to 44 years",
    age == "45 to 54 years" ~ "45 to 64 years",
    age == "55 to 59 years" ~ "45 to 64 years",
    age == "60 to 64 years" ~ "45 to 64 years",
    age == "65 to 74 years" ~ "65 years and over",
    age == "75 to 84 years" ~ "65 years and over",
    age == "85 years and over" ~ "65 years and over",
    TRUE ~ age
  )) |> 
  separate(NAME, into = c("locality", "state"), sep = ",")

ho_age <- b25007_data |> 
  group_by(year, tenure, age) |> 
  summarise(estimate = sum(estimate)) |> 
  pivot_wider(
    names_from = tenure,
    values_from = estimate
  ) |> 
  mutate(total = Homeowner + Renter) |> 
  mutate(ho_rate = (Homeowner/total))

ggplot(ho_age,
       aes(x = year, 
           y = ho_rate, 
           color = age)) +
  geom_line(stat = "identity") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Homeownership rate by age", color = "Householder age")
  

```

```{r ho-rate-race}

# years <- 2016:2020
# 
# tables <- paste0("B25003", LETTERS[2:9])
# 
# b25003_race_vars <- load_variables(2020, "acs5") %>%
#   filter(str_sub(name, end = 7) %in% tables) %>% 
#   filter(str_detect(name, "PR") == FALSE)
# 
# concept_to_race <- function(x) {
#   out <- x %>%
#     str_remove_all("TENURE \\(|\\)") %>%
#     str_to_title() %>%
#     str_replace_all("And", "and") %>%
#     str_replace_all("Or", "or") %>%
#     str_remove_all(" Alone")
#   
#   out
# }
# 
# b25003_race_clean <- b25003_race_vars %>%
#   mutate(race = concept_to_race(concept)) %>%
#   separate(label, into = c("est", "total", "tenure"), sep = "!!") %>% 
#   select(variable = name, race, tenure) %>% 
#   mutate(across(.fns = ~replace_na(.x, "All")),
#          across(.fns = ~str_remove_all(.x, ":")),
#          across(.fns = ~str_remove_all(.x, " --")),
#          across(.fns = ~str_replace_all(.x, "total", "All")),
#          across(.fns = ~str_replace_all(.x, "Tenure", "All")))
# 
# b25003_race_raw <- map_dfr(tables, function(tb) {
#   yearly_data <- map_dfr(years, function(yr) {
#     
#     acs_pull <- get_acs(
#       geography = "county",
#       table = tb,
#       year = yr,
#       state = "VA",
#       cache_table = TRUE
#     ) %>%
#       left_join(b25003_race_clean, by = "variable")
#     
#     acs_rearranged <- acs_pull %>%
#       mutate(year = yr) %>%
#       select(variable, year, locality = NAME, fips = GEOID, race, tenure,
#              estimate, moe)
#     
#     acs_rearranged
#   })
#   yearly_data
# })
# 
# b25003_race_raw <- b25003_race_raw |> 
#   subset(fips %in% pha)
# 
# b25003_race_wide <- b25003_race_raw |>  
#   select(year, locality, fips, race, tenure, estimate) |> 
#   pivot_wider(names_from = tenure,
#               values_from = estimate) |> 
#   separate(locality, into = c("locality", "state"), sep = ",") |> 
#   mutate(race = case_when(
#     race == "Black or African American Householder" ~ "Black",
#     race == "American Indian and Alaska Native Householder" ~ "Another race",
#     race == "Asian Householder" ~ "Asian",
#     race == "Native Hawaiian and Other Pacific Islander Householder" ~ "Another race",
#     race == "Some Other Race Householder" ~ "Another race",
#     race == "Two or More Races Householder" ~ "Multiracial",
#     race == "White, Not Hispanic or Latino Householder" ~ "White, non-Hispanic",
#     race == "Hispanic or Latino Householder" ~ "Hispanic or Latino"
#   )) |> 
#   clean_names() |> 
#   group_by(year, locality, fips, race) |> 
#   summarise(all = sum(all),
#             owner_occupied = sum(owner_occupied),
#             renter_occupoed = sum(renter_occupied)) |> 
#   mutate(ho_rate = owner_occupied/all)
# 
# write_rds(b25003_race_wide, "data/b25003_race_wide.rds")

b25003_race_wide <- read_rds("data/b25003_race_wide.rds")

ho_race <- ggplot(b25003_race_wide,
       aes(x = year, 
           y = ho_rate,
           colour = race)) +
  geom_line(stat = "identity") +
  facet_wrap(~locality) +
  scale_y_continuous(labels = percent_format()) +
  labs(title = "Homeownership rate by race and ethnicity", colour = "Race or ethnicity") +
  theme(axis.title.x = element_blank(),
        axis.title.y = element_blank())

plotly::ggplotly(ho_race) |> 
  plotly_camera()

```