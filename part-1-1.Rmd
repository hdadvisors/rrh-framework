# (PART)Demographic and socioeconomic changes {.unnumbered}

## Components of population change{#part-1-1}

```{r setup}
library(tidycensus)
library(tidyverse)
library(knitr)
library(janitor)
library(tigris)
library(sp)
library(scales)
library(plotly)
library(simplevis)
library(gridExtra)

rr <- c("51085", "51760", "51075", "51145", "51087", "51127", "51036", "51041")
pha <- c("51085", "51760", "51087", "51041")


# Set palette colors; may need to find a palette that better complements the PHA branding.

pha_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County")

geo_colors <- setNames(viridis(4), nm = pha_names)

pal <-colorFactor(palette = c("#440154FF", "#31688EFF","#35B779FF", "#FDE725FF"),
                  levels = c("Richmond City", "Hanover", "Henrico", "Chesterfield"))

```

The Richmond region has continued to grow between 2016 and 2020 --- adding a net of 41,457 residents across the four major localities. The most populous locality, Chesterfield County, experienced a near eight percent increase in its population during this timeframe. 
```{r total-pop}

pep_total_raw <- get_estimates(
  geography = "county",
  state = "VA",
  variables = "POP",
  year = 2019,
  time_series = TRUE
)

census_raw <- get_decennial(
  geography = "county",
  state = "VA",
  year = 2020,
  sumfile = "pl",
  variables = "P1_001N"
)

projections <- read_csv("data/uva_proj.csv") |> 
  select(FIPS, `2030`, `2040`, `2050`) |> 
  pivot_longer(cols = 2:4,
               names_to = "year",
               values_to = "value") |> 
  mutate(counttype = case_when(
    year == "2030" ~ "Forecast",
    year == "2040" ~ "Forecast",
    year == "2050" ~ "Forecast"
  )) |> 
  rename(GEOID = FIPS) |> 
  mutate(GEOID = as.character(GEOID))

pep_total_clean <- pep_total_raw %>%
  filter(!DATE %in% c(2, 3)) %>% # Remove non-decennial 2010 counts
  mutate(year = # Translate date codes into years
    case_when(
      DATE == 1 ~ "2010",
      DATE == 4 ~ "2011",
      DATE == 5 ~ "2012",
      DATE == 6 ~ "2013",
      DATE == 7 ~ "2014",
      DATE == 8 ~ "2015",
      DATE == 9 ~ "2016",
      DATE == 10 ~ "2017",
      DATE == 11 ~ "2018",
      DATE == 12 ~ "2019")) %>% 
  mutate(counttype = # Add descriptions to count types
      case_when(
        DATE == 1 ~ "Census population",
        TRUE ~ "Population estimate")) %>% 
  select( # Simplify columns
    GEOID,
    year,
    counttype,
    value
  )
# Prep total population counts from 2020 Census summary file
census_clean <- census_raw %>% 
  mutate(year = "2020", # Add year and count type columns
         counttype = "Census population") %>%
  select( # Simplify columns
    GEOID,
    year,
    counttype,
    value
  )
# Append 2020 Census counts to PEP time series
population_data <- pep_total_clean %>% 
  bind_rows(census_clean, projections)

pha_population_data <- population_data |> 
  subset(GEOID %in% pha)

# pha_pop <- counties("VA", year = 2021) |> 
#   right_join(pha_population_data, by = "GEOID") |> 
#   select(NAMELSAD, year, counttype, value) |> 
#   filter(counttype != "Forecast")

# write_rds(pha_pop, "data/pha_pop.rds")

pha_pop <- read_rds("data/pha_pop.rds")

pha_pop_compare <- pha_pop |> 
  filter(year == 2016 | year == 2020) |> 
  select(NAMELSAD, year, value) |> 
  pivot_wider(names_from = year,
              values_from = value) |> 
  mutate(difference = `2020` - `2016`,
         perchange = (difference/`2016`))

ggplot(pha_pop_compare,
       aes(x= NAMELSAD,
           y=perchange,
           fill=NAMELSAD,
           label= percent(perchange))) +
  geom_bar(stat = "identity") +
  geom_text(vjust= 1,
            color="white",
            size = 5,
            fontface="bold") +
  scale_y_continuous(labels = percent_format()) +
  labs(title="Percent change in population: 2016 to 2020") +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_fill_manual(values = geo_colors)
  

```
In recent years, nearly two thirds of growth could be attributed to migration - either domestic or international migration into the region. But between 2020 and 2021,that share increased to over three quarters --- reducing the portion of the population growing due to natural increase at only 13 percent.

The region's growth continues to be incredibly driven by new people coming from other parts of the state and nation (64 percent of growth between 2020 and 2021). 


```{r natural}

# PEP does not have data available for 2020 and 2021. There is a gap between 2019 and 2021 because Census uses 2020 as a baseline. 

region <- c(51036, 51041, 51075, 51085, 51087, 51127, 51145, 51760)


pep_change_raw <- get_estimates(
  geography = "county",
  state = "VA",
  variables = c("NATURALINC", "DOMESTICMIG", "INTERNATIONALMIG"),
  time_series = TRUE
)

pep_change_clean <- pep_change_raw %>% 
  mutate(year = # Translate date codes into years
    case_when(
      PERIOD == 1 ~ "2010",
      PERIOD == 2 ~ "2011",
      PERIOD == 3 ~ "2012",
      PERIOD == 4 ~ "2013",
      PERIOD == 5 ~ "2014",
      PERIOD == 6 ~ "2015",
      PERIOD == 7 ~ "2016",
      PERIOD == 8 ~ "2017",
      PERIOD == 9 ~ "2018",
      PERIOD == 10 ~ "2019")) %>%
  mutate(component = # Rename components of change
    case_when(
      variable == "NATURALINC" ~ "Natural increase",
      variable == "DOMESTICMIG" ~ "Domestic migration",
      variable == "INTERNATIONALMIG" ~ "International migration")) %>% 
  select( # Simplify columns
    GEOID,
    year,
    component,
    value
  )

rr_nat_change <- pep_change_clean |> 
  mutate(GEOID = as.character(GEOID)) |> 
  filter(GEOID %in% pha)

# Maybe manually add in 2021. There will be a gap at 2020 though.

#I've cleaned the 2021 csv and it can be found at the below:

pep_2021 <- read_csv("data/comp_chang_2021.csv") |> 
  pivot_longer(4:6,
               names_to = "component",
               values_to = "value") |> 
  mutate(year = 2021,
         component =
    case_when(
      component == "NATURALINC" ~ "Natural increase",
      component == "DOMESTICMIG" ~ "Domestic migration",
      component == "INTERNATIONALMIG" ~ "International migration")) |> 
  select(GEOID, year, component, value) |> 
  mutate(GEOID = as.character(GEOID)) |> 
  filter(GEOID %in% pha)

comp_chg <- rr_nat_change |> 
  rbind(pep_2021)

comp_chg_summary <- comp_chg |> 
  group_by(year, component) |> 
  summarise(value = sum(value)) |> 
  mutate(year = as.numeric(year),
         percent = value/sum(value)) |> 
  filter(year >= 2016)

chg_bar<-ggplot(comp_chg_summary,
       aes(x=year,
           y=percent,
           fill=component)) + 
  geom_bar(stat="identity", position = "stack") +
  labs(title="Components of population change") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = percent_format()) +
  scale_fill_manual(values = viridis(3))

ggplotly(chg_bar) |> 
  simplevis::plotly_camera()

```

Between 2020 and 2050, the region is expected to grow by nearly a third (29 percent) --- reaching 1,338,306 residents. 

```{r forecast}

forecasts <- population_data |> 
  filter(GEOID %in% pha) |> 
  mutate(name = case_when(
    GEOID == "51085" ~ "Hanover County", 
    GEOID == "51760" ~ "Richmond city", 
    GEOID == "51087" ~ "Henrico County", 
    GEOID == "51041" ~ "Chesterfield County"
  )) |> 
  filter(year == 2020 | year == 2030 | year == 2040 | year == 2050) |> 
  group_by(year, counttype) |> 
  summarise(value = sum(value))


  
forecast_bar <- ggplot(forecasts,
       aes(x=year,
           y= value,
           fill=counttype)) +
  geom_bar(stat="identity") +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank()) +
  labs(title="Population projections:2020 to 2050", fill="Estimate type")

ggplotly(forecast_bar) |> 
  plotly_camera()

# Difference between 2050 and 2020 is 302,780. 29 percent increase.

```
Over the next 30 years, Chesterfield County will continue to lead growth across the region. By 2050, Chesterfield is expected to surpass half a million residents, growing by 38 percent from the 2020 Census estimates. Population growth trends will largely continue as they have with Hanover County experiencing the second greatest growth from their 2020 estimates (27 percent increase). Henrico County follows with a 26 percent increase (+88,565), while the City of Richmond will only increase by about a fifth (20 percent) over 30 years.

```{r forecasts-ind}

forecasts_ind <- population_data |> 
  filter(GEOID %in% pha) |> 
  mutate(name = case_when(
    GEOID == "51085" ~ "Hanover County", 
    GEOID == "51760" ~ "Richmond city", 
    GEOID == "51087" ~ "Henrico County", 
    GEOID == "51041" ~ "Chesterfield County"
  )) |> 
  filter(year == 2020 | year == 2030 | year == 2040 | year == 2050)

forecast_bar_ind <- ggplot(forecasts_ind,
       aes(x=year,
           y= value,
           fill=name)) +
  geom_bar(stat="identity") +
  facet_wrap(~name) +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  labs(title="Population projections by locality: 2020 to 2050") +
  scale_fill_manual(values = geo_colors)

ggplotly(forecast_bar_ind) |> 
  plotly_camera()

# Chesterfield - 140,266 difference / 38 percent increase
# Hanover - 30,134 difference / 27 percent increase
# Henrico - 88,565 difference / 26 percent increase
# Richmond - 43,815 difference / 19 percent increase

```
