# Richmond City {#part-4-1}

This chapter is a summary of the major changes to the City of Richmond's population and housing market in the past five years.

```{r setup}

library(tidyverse)
library(tidycensus)
library(sf)
library(sp)
library(plotly)
library(tidytext)
library(scales)
library(readxl)
library(zoo)
library(lubridate)
library(janitor)
library(tigris)
library(tidytext)
library(FinCal)
library(viridis)
library(hdatools)
library(ggiraph)
library(ggtext)

years <- 2016:2020
fips <- 51760
name <- "Richmond city"
costar_name <- "Richmond City"


```

## Takeaways

-   The City of Richmond has largely grown as a result of international migration and natural increase (+817 between 2020 and 2021).
-   Growth in renter households in the city has been the direct result of nonfamily households --- while renters with children have significantly decreased (-2,192).
-   Rents across the city have grown substantially, especially the Northside and Southside rental markets (growing by nearly 40 percent, respectively since 2016).
-   The typical renter household still has an income unable to afford the average asking rent, as well as the median home price in the city.
-   Renter cost burden has increased 1,107 households from 2015 to 2018.
-   The greatest need still remains for households making below 30 percent AMI; there was a shortage of nearly 11,000 rental homes for extremely low-income households.

## Demographic and socioeconomic changes

### Population changes

Between 2010 and 2020, the U.S. Census Bureau has estimated that the City of Richmond has grown by 11 percent --- an increase of 22,396 residents. Throughout much of the decade the city has been on a slow upward trend until 2020. The 2020 Census estimate shows a slight decline from the 2019 estimate --- a loss of 3,826 residents. This change could be a result of the difficulties associated with [undercounts during the 2020 Census](https://censuscounts.org/whats-at-stake/will-you-count-renters-in-the-2020-census/).

```{r}
#| label: fig-pop
#| fig-cap: !expr "paste0(name, \": Total Population\")"

pop <- read_rds("data/rr_pop_data.rds") |> 
  mutate(GEOID = parse_number(GEOID)) |> 
  filter(counttype != "Forecast",
         GEOID == fips)

pop_bar <- ggplot(pop,
                      aes(x = year,
                          y = value,
                          fill = value,
                          data_id = value,
                          tooltip = label_comma()(value))) +
  geom_col() +
  geom_col_interactive(size = 2) +
  scale_fill_gradientn(colours = c("#CAE3C2", "#74BA91", "#519B8D", "#2B4258")) +
  theme_pha() +
  labs(title = paste0(name, ": Total Population"),
       subtitle = "2010 to 2020",
       caption = "**Source:** U.S. Census Bureau Decennial Census and American Community Survey.") +
  scale_y_continuous(labels = label_comma()) +
  theme(axis.title = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05)) +
  theme(plot.title.position = "plot",
        plot.caption.position = "plot")

if (knitr::is_html_output()) {
  
  girafe(ggobj = pop_bar,
         height_svg = 4)
} else {
  
  pop_bar
}

```

Census estimates from 2016 show Richmond gaining more than 2,000 net persons that year who moved from somewhere else in the state or country. However, the city has experienced a net loss in domestic migration since then. The majority of the city's population growth over the past five years has been due to migration from abroad along with natural increases through new births.

```{r}
#| label: fig-comp
#| fig-cap: !expr "paste0(name, \": Components of population change\")"

change <- read_rds("data/rr_comp_change.rds") |> 
  filter(year %in% as.character(years) | year == "2021") |> 
  filter(NAMELSAD == name)

pop_change <- ggplot(change,
       aes(x = year,
           y = value,
           fill = component,
           data_id = value,
           tooltip = value)) +
  geom_col() +
  geom_col_interactive(size = 2) +
  facet_wrap(~component) +
  theme_pha() +
  scale_fill_pha() +
  labs(title = paste0(name,": Components of population change"), 
       subtitle = "2016 through 2021",
       caption = "**Note:** 2020 components of change data not available.<br>**Source:** U.S. Census Bureau, Population Estimates Program.")  +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus")) 


if (knitr::is_html_output()) {
  
  girafe(ggobj = pop_change,
         height_svg = 4)
  
} else {
  
  pop_change
  
  }

```

### Household characteristics

Between 2016 and 2020, there have been distinct changes between homeowner and renter households in the city. The city has seen a 2,555 increase in homeowner households with no children, while the number of renter household with no children has decreased by 607. At the other end of the spectrum, there has been a significant decrease in renter households with children (-2,192), while there are only 162 fewer homeowner households with children in the city. These trends seem to suggest affordability challenges in the homeownership and rental markets of the city.

New homeowners without children (and with fewer financial responsibilities) often find it easier to afford a home, while renters with children are finding it difficulty to afford even a rental --- most likely due to lack of larger rental options, as well as increasing costs.

Nonfamily households have seen an increase for both homeowners and renters, but especially for renters (+1,874). This is likely a result of the student population, as well as young professionals, needing additional roommates to afford increasing rents in the city.

```{r}
#| label: fig-children
#| fig-cap: !expr "paste0(name, \": Change in households with children by tenure\")"


# Add choice of household stat (HHs with children, HHs with seniors, subfamilies, etc)

b25115 <- read_rds("data/b25115_data.rds") |> 
  filter(NAME == name)

ch_plot <- ggplot(b25115,
       aes(x = children, 
           y = change, 
           fill = tenure,
           data_id = change,
           tooltip = label_comma()(change))) +
  geom_col(position = "dodge") + 
  geom_col_interactive(position = "dodge", size = 2) +
  theme_pha() + 
  scale_fill_pha() +
  facet_wrap(~children, nrow = 1, scales = "free_x") +
  scale_y_continuous(labels = label_number(style_positive = "plus", big.mark = ",")) +
  labs(title = paste0(name, ": Change in households with children by tenure"),
       subtitle = "2016 to 2020",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, Table B25115.") 


if (knitr::is_html_output()) {
  
  girafe(ggobj = ch_plot,
         height_svg = 4)
  
} else {
  
  ch_plot
  
  }

```

Since 2016, the number of seniors (65 years and over) has been on the rise in the city --- especially among seniors living alone (+1,695). The rise in seniors living alone is a result of the ongoing [desire of older adults to age in place.](https://www.aarp.org/home-family/your-home/info-2021/home-and-community-preferences-survey.html) As this trend continues, so do concerns for senior ability to age in place comfortably with ongoing home maintenance needs or rising rent on fixed incomes.

```{r}
#| label: fig-seniors
#| fig-cap: !expr "paste0(name, \": Change in senior population by living arrangement\")"

b09020 <- read_rds("data/b09020_data.rds") |> 
  filter(NAME == name) |> 
  mutate(family = str_replace(family, "Group quarters", " "),
         family = fct_relevel(family, "Family", "Nonfamily", " "))

snr_plot <- ggplot(b09020,
       aes(y = reorder_within(relationship, change, family),
           x = change,
           fill = family,
           data_id = change,
           tooltip = change)) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_pha() +
  scale_fill_pha() +
  scale_y_reordered() +
  scale_x_continuous(labels = label_comma()) +
  facet_grid(rows = vars(family), scales = "free_y", space = "free", switch = "y") +
  #scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +
  labs(title = paste0(name, ": Change in senior population by living arrangement"),
       subtitle="2016 to 2020",
       fill="Tenure",
       caption = "**Source:** U.S. Census Bureau, American Community Survey, Table B09020.")  +
  theme(strip.placement = "outside",
        panel.grid.major.y = element_blank(),
        panel.grid.major.x = element_line(color = "#e2e4e3",
                                          size = 0.05))

if (knitr::is_html_output()) {
  
  girafe(ggobj = snr_plot,
         height_svg = 4)
  
} else {
  
  snr_plot
  
  }

```

### Income and wages

There are wide disparities between homeowner and renter incomes in the City of Richmond. The median homeowner household income (\$79,858) is over double that of the median renter household income (\$36,249). This gap has been persistent in spite of a 16 percent increase in median household income for renters between 2016 and 2020.

```{r}
#| label: fig-income
#| fig-cap: !expr "paste0(name, \": Median houshold income by tenure\")"

# Add choice of income stat (probably median household income of some kind)

b25119_cpi <-read_rds("data/b25119_cpi.rds") |> 
  filter(NAME == name)

inc_plot <- ggplot(b25119_cpi, 
       aes(x = year,
           y = dollars20,
           fill = tenure,
           data_id = dollars20,
           tooltip = dollar_format()(dollars20))) +
  geom_col() +
  geom_col_interactive(size =2) +
  theme_pha() +
  scale_fill_pha() +
  facet_wrap(~tenure) +
  scale_y_continuous(labels = dollar_format(), limits = c(0, NA)) +
  labs(title = paste0(name, ": Median houshold income by tenure"), 
       color = "Tenure",
       subtitle = "2016 to 2020 | Adjusted to 2020 dollars",
       caption = "**Source:** U.S. Census Bureau, American Community Survey")

if (knitr::is_html_output()) {
  
  girafe(ggobj = inc_plot,
         height_svg = 4)
  
} else {
  
  inc_plot
  
  }
```

### Persons with disabilities

Independent living difficulties make it necessary for many individuals to seek assisted living facilities or significant modifications to their home to continue to live comfortably. However, both options can be costly --- increasing the need for funding of home accessibility rehabilitation or new accessible housing construction.

Since 2016, there are now over 500 more persons in the city with independent living difficulties. This growth has been among younger adults (under 35) and "young" seniors (65 to 74). The latter group's growth is likely the result of middle-age adults with these difficulties (which saw a large decline) aging into this category in the last five years.

```{r}
#| label: fig-ind-living
#| fig-cap: !expr "paste0(name, \": Net change in individuals with independent living difficulties by age\")"


# Add disability stat (probably independent living difficulty)

b18107 <- read_rds("data/b18107_data.rds") |> 
  filter(NAME == name) |> 
  group_by(age) |> 
  summarise(change = sum(change))

b18107 <- read_rds("data/b18107_data.rds") |> 
  filter(NAME == name) |> 
  group_by(age) |> 
  summarise(change = sum(change))

ind_plot <- ggplot(b18107,
       aes(x = age,
           y = change,
           fill = age,
           data_id = change,
           tooltip = change)) +
  geom_col() +
  geom_col_interactive(size = 2) +
  theme_pha() +
  scale_fill_pha() +
  labs(title=paste0(name, ": Net change in individuals with<br>independent living difficulties by age"),
       subtitle="2016 to 2020",
       caption="**Source:** U.S. Census Bureau, American Community Survey, Table B18107.") +
  scale_y_continuous(labels = label_comma()) 

if (knitr::is_html_output()) {
  
  girafe(ggobj = ind_plot,
         height_svg = 4)
  
} else {
  
  ind_plot
  
  }
```

## Housing supply and market changes

### Homeownership

From the start of 2017 to June 2022, the median home price in the city has increased by 52 percent --- going from \$256,418 to \$389,355. Prices have begun to come down amid a housing slump brought upon by rising interest rates, but still remain high.

```{r}
#| label: fig-sales
#| fig-cap: !expr "paste0(name, \": Median home sales price\")"

# Median sales price over time

price <- read_csv("data/richmond_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = name) |> 
  pivot_longer(cols = starts_with("sale"),
    names_to = "label",
    values_to = "med_price",
    values_drop_na = TRUE) |> 
  mutate(year = substr(label, 19,23)) |> 
  select(geography, year, month, med_price)

price$month <- match(price$month, month.abb)

price <- price |> 
  mutate(date = make_date(year, month)) |> 
  mutate(med_price = parse_number(med_price))

cpi <- read_csv("data/CPIAUCSL.csv") |> 
  select(date = DATE, cpi = CPIAUCSL)

price_adj <- price |> 
  left_join(cpi, by = "date") |> 
  mutate(dollars = ((296.761/cpi)*med_price)) |> 
  select(date, med_price, dollars) |> 
  pivot_longer(2:3,
               names_to = "type",
               values_to = "dollars") |> 
  filter(type == "dollars")

sales_plot <- ggplot(price_adj,
       aes(x = date,
           y = dollars,
           color = dollars,
           group = 1)) +
  geom_line(size = 1) +
  geom_point_interactive(
    aes(data_id = dollars,
        tooltip = label_dollar()(dollars)),
    size = 0.5) + 
  theme_pha() +
  scale_color_gradientn(colours = c("#CAE3C2", "#74BA91", "#519B8D", "#2B4258")) +
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
  labs(title = paste0(name, ": Median home sales price"),
       subtitle = "January 2017 to September 2022",
       caption = "**Source:** Central Virginia Regional Multiple Listing Service.") +
  geom_smooth(method = "lm", color = "#Be451c")

if (knitr::is_html_output()) {
  
  girafe(ggobj = sales_plot,
         height_svg = 4)
  
} else {
  
  sales_plot
  
  }

```

### Rental

Rents across the city have steadily risen over the last ten years, accelerating most rapidly in the pandemic's wake since 2020. This trend is present across all of CoStar's five submarkets for the city, especially for Northside and South Richmond. These submarkets have seen some of the largest average rent increases over time, each growing around 40 percent since 2016.

```{r}
#| label: fig-rent-submarket
#| fig-cap: !expr "paste0(name, \": Average asking rent by submarket\")"

# Average asking rent over time (by submarket if applicable, maybe by bedroom if no submarkets)

# Disaggregate by Richmond CoStar Submarket

# CoStar Filters: Construction Status - Existing

# Added locality field manually

sub_rent <- read_csv("data/rr_submarket_data.csv") |> 
  clean_names() |> 
  separate(geography, into = c("region", "state", "submarket"), sep = " - ") |> 
  select(period, locality, submarket, "rent" = market_asking_rent_unit, vacancy_rate) |> 
  mutate(rent = parse_number(rent)) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  filter(locality == costar_name)

# Issue with above is that rents are not inflation-adjusted. May need to revisit. I've requested from CoStar to allow for an inflation-adjusted average rent per unit pull, BUT who knows if they can add it. Might consider just having a table with most recent rents.

sub_plot <- ggplot(sub_rent,
       aes(x = period,
           y = rent, 
           color = submarket)) +
  geom_line(size = 1) +
  geom_point_interactive(
    aes(data_id = rent,
        tooltip = label_dollar()(rent)),
    size = 0.5) + 
  theme_pha() +
  scale_color_pha() + 
  labs(title = paste0(name, ": Average asking rent"),
       subtitle = "2016 Q1 to 2022 Q3 | Not adjusted for inflation",
       color = "Submarket") +
  scale_y_continuous(labels = label_dollar()) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years", limits = as.Date(c("2016-01-01", "2022-09-30"))) +
  theme(legend.position = "top")

if (knitr::is_html_output()) {
  
  girafe(ggobj = sub_plot,
         height_svg = 4)
  
} else {
  
  sub_plot
  
  }
```

```{r}
#| label: tbl-submarket-table
#| tbl-cap: !expr "paste0(name, \": Submarket rents\")"

library(kableExtra)
library(formattable)

sub_rent_tbl <- read_csv("data/rr_submarket_data.csv") |> 
  clean_names() |> 
  separate(geography, into = c("region", "state", "submarket"), sep = " - ") |> 
  select(period, locality, submarket, "rent" = market_asking_rent_unit) |> 
  mutate(rent = parse_number(rent)) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  filter(locality == costar_name) |> 
  filter(period == "2022-09-30" | period == "2016-03-31") |> 
  pivot_wider(names_from = period,
              values_from = rent)

sub_tbl <- sub_rent_tbl |> 
  select(2:4) |> 
  mutate(pct_change = (`2022-09-30`-`2016-03-31`)/`2016-03-31`) |> 
  mutate(across(c(2,3), ~currency(.x, digits = 0)),
         pct_change = percent(pct_change, digits = 0)) |> 
  arrange(desc(pct_change))

sub_tbl |> 
  kable(
        # caption = "Change in average rents by Richmond submarket",
        col.names = c("Richmond submarket", "2016 Q1 Rent", "2022 Q3 Rent", "Percent change")) |> 
  kableExtra::kable_styling(
    bootstrap_options = c("condensed", "striped", "hover")) |> 
  kableExtra::footnote(general = "2016 Q1 Rent has not been adjusted for inflation")

```

### Housing assistance

Since January 2020, Richmond has seen 23 new rental subsidies added, which increased the number of active affordability contracts on units by 1,869. Over that same period, 10 subsidies ended, affecting 435 units. Some properties had multiple subsidies either added or expired. In all, there was a net addition of 1,434 rental affordability contracts.

```{r}
#| label: tbl-nhpd
#| tbl-cap: !expr "paste0(name, \": Added and removed affordable rental contracts since 2020\")"

nhpd_coded_rr <- read_rds("data/nhpd_coded_rr.rds") |> 
  filter(locality == "Richmond City")

change <- nhpd_coded_rr |>
  mutate(change_type = case_when(
    start_date > '2019-12-31' ~ "Added",
    end_date < '2022-09-01' & end_date > '2019-12-31' ~ "Removed",
    TRUE ~ "No change"))

change_table <- change |>
  group_by(change_type) |>
  summarise(subsidies = n(),
            properties = n_distinct(nhpd_property_id),
            units = sum(assisted_units)) |>
  filter(change_type != "No change") |>
  mutate(across(where(is.numeric), ~ ifelse(change_type == "Removed", (.x * -1), .x))) |>
  adorn_totals(name = "Net change")

change_table |>
  mutate(across(where(is.numeric), ~ comma(.x, digits = 0))) |>
  kable(align = "lrrr",
        col.names = c("", "Subsidies", "Properties affected", "Units included")) |>
  kableExtra::kable_styling(bootstrap_options = c("condensed", "striped")) |>
  kableExtra::row_spec(3, bold = TRUE) |>
  kableExtra::footnote(general = "Sources: National Housing Preservation Database and Virginia Housing.",
                       general_title = "")

```


### Naturally-occurring affordable housing

As defined in this report, there are 128 rental properties in the City of Richmond that qualify as naturally-occurring affordable housing. There are more than 9,100 apartments across these properties, which make up approximately 25 percent of all multifamily (two or more units) rental housing in the city.

Older NOAH properties command slightly higher rents than those built in 1960 and beyond. Most of the pre-1960 properties are located in the city's older neighborhoods north of the river, such as Shockoe Bottom and The Fan, and have average rents between \$1,000 and \$1,400. "Newer" NOAH units built in the 1960s and afterward are generally located in the Northside and Southside areas of the city and have average rents between \$750 and \$1,000.

```{r}
#| label: fig-noah
#| fig-cap: !expr "paste0(name, \": Distribution of average asking rents in NOAH properties by year built\")"

# Add choice of NOAH stat (total number, change in rent, etc) 

noah <- read_csv("data/pha_noah_81722.csv") |> 
  clean_names() |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE) |> 
  filter(property_name != "Sedgefield" | property_name != "Holidy Mobile Home Park") |> 
  filter(county_name == costar_name) |> 
  mutate(period_built = case_when(
    year_built < 1940 ~ "Before 1940",
    year_built %in% 1940:1959 ~ "1940 to 1959",
    year_built %in% 1960:1969 ~ "1960 to 1969",
    year_built > 1969 ~ "1970 or after"
  )) |> 
  mutate(period_built = fct_relevel(period_built, "Before 1940"))
  

noah_plot <- ggplot(noah,
       aes(x = period_built,
           y = avg_asking_unit,
           fill= period_built,
           data_id = avg_asking_unit,
           tooltip = avg_asking_unit)) +
  geom_boxplot(lwd= 1, flatten = 1) + 
  geom_boxplot_interactive(lwd= 1, flatten = 1, size = 2) +
  theme_pha() +
  scale_fill_pha() +
  scale_y_continuous(labels = label_dollar()) +
  labs(title = paste0(name, ": Distribution of average asking rents in NOAH properties by year built"),
       caption = "**Source:** CoStar Group, Inc.")
  
if (knitr::is_html_output()) {
  
  girafe(ggobj = noah_plot,
         height_svg = 4) 
  
} else {
  
  noah_plot
  
  }
  

```

## Gap analysis

### Affordability of current housing stock

Based on the 2020 median renter income estimate, the affordable rent for an average renting household is around \$900. This was several hundred dollars below what the average asking rent for an apartment was in 2020. Although low-end wage growth has increased the purchasing power of working class households, extra take-home pay is likely to be used up for higher costs of goods---and accelerating rents.

```{r}
#| label: fig-income-rent-gap
#| fig-cap: !expr "paste0(name, \": Average asking rent versus rent affordable to median renter income\")"

# Compare local median renter income to average asking rent

b25119_cpi_rent <- read_rds("data/b25119_cpi.rds") |> 
  filter(tenure == "Renter",
         NAME == name)

rent <- read_csv("data/rr_annual_rent.csv") |> 
    pivot_longer(cols = 2:8,
               names_to = "locality",
               values_to = "rent_current") |> 
  clean_names() |> 
  filter(locality == costar_name)

rent_gap <- b25119_cpi_rent |> 
  left_join(rent, by = "year") |> 
  mutate(rent_current = parse_number(rent_current)) |> 
  mutate(affordable_rent = (cdollars/12)*.30) |> 
  mutate(difference = rent_current - affordable_rent) |> 
  select(year, rent_current, affordable_rent) |> 
  pivot_longer(2:3,
               names_to = "type",
               values_to = "dollars") |> 
  mutate(type = case_when(
    type == "affordable_rent" ~ "Affordable rent",
    type == "rent_current" ~ "Current rent"
  ))

rentgap <- ggplot(rent_gap,
       aes(x = year,
           y = dollars,
           fill = type,
           data_id = dollars, 
           tooltip = dollar_format()(dollars))) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size =2) +
  theme_pha() +
  scale_fill_pha() +
  scale_y_continuous(labels = label_dollar()) +
  labs(title = "Hanover County: Average asking rent versus<br>rent affordable to median renter income",
       subtitle = "2016 to 2020",
       fill = "Nominal rent",
       caption = "**Sources:** U.S. Census Bureau, American Community Survey, Table B25119<br>and CoStar Group Inc.") +
  theme(legend.position = "top")

if (knitr::is_html_output()) {
  
  girafe(ggobj = rentgap,
         height_svg = 4)
  
} else {
  
  rentgap
  
  }

```

The average renter in the city would also be very challenged to find an affordable home to purchase. This gap does not even factor in downpayment savings, credit worthiness, and other important factors.

```{r}
#| label: fig-income-own-gap
#| fig-cap: !expr "paste0(name, \": Income needed to afford median home price versus median renter income\")"

# Compare local renter income versus local home prices

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names() |> 
  filter(locality == costar_name)

int_annual <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
utilities <- 250 # Assume $250/month for utilities

sale <- rr_sales_annual |> 
  left_join(b25119_cpi_rent, by = "year") |> 
  left_join(int_annual, by = "year") |> 
  drop_na() |> 
  mutate(principal = price - (price*downpayment)) |> 
  mutate(loanamt = principal/(1-closingcosts)) |> 
  mutate(mortgage = abs(PMT((annual_int/12), 360, loanamt)) + 250) |> 
  mutate(inc_needed = ((mortgage*10)/2.8)*12) |> 
  select(year, inc_needed, cdollars)

slgap <- sale |> 
  pivot_longer(2:3,
               names_to = "data",
               values_to = "value") |> 
  mutate(data = case_when(
    data == "cdollars" ~ "Renter median household income",
    data == "inc_needed" ~ "Income needed to afford median home price"
  ))

slgap_plot <- ggplot(price_afford,
       aes(x = year,
           y = value,
           fill = str_wrap(type, 25),
           data_id = value,
           tooltip = dollar_format()(value))) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  scale_y_continuous(labels = label_dollar()) + 
  theme_pha() +
  scale_fill_pha() +
labs(title = "Hanover County: Income needed to afford median home price<br>versus median renter income",
       subtitle = "2016 to 2020",
       fill = "Nominal income",
       caption = "**Sources:** U.S. Census Bureau, American Community Survey, Table B25119<br>and Central Virginia Regional Multiple Listing Service.") +
  theme(legend.position = "top")

if (knitr::is_html_output()) {
  
  girafe(ggobj = slgap_plot,
         height_svg = 4) 
  
} else {
  
  slgap_plot
  
  }


```

Based on HUD Comprehensive Housing Affordability Strategy (CHAS) data, there was a shortage of 17,834 rental homes for households making less than 80 percent AMI. This was a deficit increase of 300 homes from 2015 when the shortage was 17,534. The most severe shortage in the City of Richmond is among deeply affordable rentals for households at 30 percent AMI or less.

But there has been a growing shortage among higher income households between 31 and 80 percent AMI.

```{r}
#| label: fig-gap
#| fig-cap: !expr "paste0(name, \": Rental housing gap by AMI\")"

# Add choice of affordability stat (surplus/deficit, income vs prices, etc)

gap <- read_rds("data/tb_18_match.rds") |> 
  filter(county == name) |> 
  group_by(year, household_income, gapcode) |>
  summarise(estimate = sum(estimate)) |>
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |>
  mutate(gapcode = case_when(
    gapcode == "Gap" ~ "Shortage of units",
    gapcode == "Matches or less than income" ~ "Households at or less than income"
  )) |>
  filter(household_income != "80 percent AMI or greater")

gap_plot <- ggplot(gap,
       aes(x = year, 
           y = estimate,
           fill = str_wrap(gapcode, 25),
           data_id = estimate,
           tooltip = estimate)) +
  geom_col() + 
  geom_col_interactive(size = 2) + 
  facet_grid(~household_income) + 
  theme_pha() +
  scale_fill_pha() + 
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Rental housing gap by AMI"),
       subtitle = "2015 to 2018",
       caption = "**Source:** U.S. Department of Housing and Urban Development,<br>Comprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(legend.position = "top")

if (knitr::is_html_output()) {
  
  girafe(ggobj = gap_plot,
         height_svg = 4) 
  
} else {
  
  gap_plot
  
  }

```

### Impact of housing costs

Rising rents have continued to increase the number of renters with cost burden in the city, although there are possible signs of decelerating growth. Meanwhile, cost burden among homeowners is become much less common.

```{r}
#| label: fig-cb
#| fig-cap: !expr "paste0(name, \": Cumulative change in cost-burdened households by tenure\")"

cb <- read_rds("data/cb_7.rds") |> 
  filter(county == name,
         cb_group == "Cost-burdened") |> 
  group_by(year, county, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change))

cb_diff <- ggplot(cb,
       aes(x = year, 
           y = run_diff, 
           fill = tenure,
           data_id = run_diff,
           tooltip = run_diff)) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_pha() +
  scale_fill_pha() +
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Cumulative change in cost-burdened households by tenure"),
       subtitle = "2015 to 2018",
       fill = "Tenure",
       caption = "**Source:** U.S Department of Housing and Urban Development,<br>Comprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(panel.background = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05)) 


if (knitr::is_html_output()) {
  
  girafe(ggobj = cb_diff,
         height_svg = 4) 
  
} else {
  
  cb_diff
  
  }

```

Federal and state eviction protections during the pandemic significantly reduced the number of eviction filings and judgements processed by Richmond City District Court. However, these measures have now expired---along with the state's rent relief program. As the RVA Eviction Lab has cited in their [most recent quarterly memo](https://rampages.us/rvaevictionlab/2022/10/31/2nd-3rd-quarter-2022-report-memo/), eviction filings are well on their way to surpassing pre-pandemic levels --- especially in the City of Richmond.

```{r}
#| label: fig-evictions
#| fig-cap: !expr "paste0(name, \": Evictions filings and judgements\")"

evictions <- read_csv("data/evictions_17_22.csv") |> 
  pivot_longer(3:142,
               names_to = "data",
               values_to = "value") |> 
  mutate(type = case_when(
    str_detect(data, "Filings") ~ "Filings",
    str_detect(data,"Evictions") ~ "Eviction judgements"
  )) |> 
  mutate(date = str_sub(data, -7, -1)) |> 
  mutate(date = ym(date)) |> 
  mutate(year = year(date)) |> 
  mutate(type = fct_relevel(type, "Filings", "Eviction judgements")) |> 
  filter(Jurisdiction == costar_name)

eviction_colors <- setNames(c("#f39152", "#be451c"),
                            nm = c("Filings", "Eviction judgements"))

evict_plot <- ggplot(evictions,
       aes(x = date,
           y = value,
           fill = type,
           data_id = value,
           tooltip = value)) +
  geom_col(position = "dodge") +
  geom_col_interactive(position = "dodge", size = 2) +
  theme_pha() +
  scale_x_date(labels = label_date_short(), breaks = breaks_width("6 months")) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Evictions filings and judgements"),
       subtitle = "January 2017 through October 2022",
       caption = "Source: RVA Eviction Lab") +
  scale_fill_manual(values = eviction_colors) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())


if (knitr::is_html_output()) {
  
  girafe(ggobj = evict_plot,
         height_svg = 4) 
  
} else {
  
  evict_plot
  
  }
```
