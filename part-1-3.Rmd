# Incomes and wages {#part-1-3}

```{r setup}

library(tidyverse)
library(tidycensus)
library(tigris)
library(lubridate)
library(readxl)
library(viridis)
library(leaflet)
library(scales)

# rr includes Charles City, Goochland, New Kent, and Powhatan.

rr <- c("51085", "51760", "51075", "51145", "51087", "51127", "51036", "51041")

pha <- c("51085", "51760", "51087", "51041")

# Set palette colors; may need to find a palette that better complements the PHA branding.

pha_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County")

geo_colors <- setNames(viridis(4), nm = pha_names)

pal <-colorFactor(palette = c("#440154FF", "#31688EFF","#35B779FF", "#FDE725FF"),
                  levels = c("Richmond City", "Hanover", "Henrico", "Chesterfield"))

tenure <- c("Homeowner", "Renter")

tenure_colors <-setNames(viridis(2), nm = tenure)

years <- 2016:2020

```

## Household incomes

From 2016 to 2020, homewo

```{r hh-inc-data, eval=FALSE}

b25118_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25118")

b25118_raw <- map_dfr(years, function(yr){
  b25118_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25118",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
  })

b25118_raw <- b25118_raw |> 
  subset(GEOID %in% rr)

b25118_vars_cleaned <- b25118_vars |> 
  separate(label, into = c("est", "total", "tenure", "income"), sep = "!!") |>  
  select(variable = name, tenure, income) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied:" ~ "Homeowner",
    tenure == "Renter occupied:" ~ "Renter"
  )) |> 
  drop_na()

b25118_data <- b25118_raw |> 
  right_join(b25118_vars_cleaned, by = "variable") |> 
  select(NAME, year, tenure, income, estimate) |> 
  mutate(NAME = str_remove_all(NAME, ", Virginia")) |>
  mutate(income = case_when(
    income == "Less than $5,000" ~ "Less than $15,000",
    income == "$5,000 to $9,999" ~ "Less than $15,000",
    income == "$10,000 to $14,999" ~ "Less than $15,000",
    income == "$15,000 to $19,999" ~ "$15,000 to $24,999",
    income == "$$20,000 to $24,999" ~ "$15,000 to $24,999",
    income == "$25,000 to $34,999" ~ "$25,000 to $49,999",
    income == "$35,000 to $49,999" ~ "$25,000 to $49,999",
    income == "$50,000 to $74,999" ~ "$50,000 to $74,999",
    TRUE ~ income
  )) |> 
  group_by(NAME, year, tenure, income) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(year %in% c(2016, 2020)) |> 
  pivot_wider(names_from = year,
              values_from = estimate) |>
  mutate(change = `2020` - `2016`,
         pct_change = change/`2016`)
  
write_rds(b25118_data, "data/b25118_data.rds")

```

```{r hh-inc-plot}

b25118_data <-read_rds("data/b25118_data.rds") |> 
  filter(NAME %in% pha_names) |>
  group_by(tenure, income) |> 
  summarise(`2016` = sum(`2016`),
            `2020` = sum(`2020`)) |> 
  mutate(change = `2020`-`2016`,
         pct_change = change/`2016`)

ggplot(b25118_data, 
       aes(y = income,
           x = change,
           fill = tenure)) +
  geom_col(position = "dodge") +
  facet_grid(~tenure) +
  scale_x_continuous(labels = label_comma()) +
  scale_y_discrete(limits = c("Less than $15,000","$15,000 to $24,999",
                              "$25,000 to $49,999", "$50,000 to $74,999",
                              "$75,000 to $99,999", "$100,000 to $149,999",
                              "$150,000 or more"),
                   labels = function(x) str_wrap(x, width = 12)) +
  labs(title = "Change households by tenure and income level",
       subtitle="2016 to 2020",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B25118.") +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "none",
        panel.grid.major.x = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())
```

```{r med-income-data}

b25119_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25119")

b25119_raw <- map_dfr(years, function(yr){
  b25119_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25119",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) %>%
    mutate(year = yr)
  })

b25119_raw <- b25119_raw |> 
  subset(GEOID %in% rr)

b25119_vars_cleaned <- b25119_vars |> 
  separate(label, into = c("est", "income", "total", "tenure"), sep = "!!") |>  
  select(variable = name, tenure) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied (dollars)" ~ "Homeowner",
    tenure == "Renter occupied (dollars)" ~ "Renter"
  ))

b25119_vars_cleaned$tenure <- b25119_vars_cleaned$tenure |>  replace_na('All households')

b25119_data <- b25119_raw |> 
  right_join(b25119_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, tenure, estimate, moe)

cpi <- read_excel("data/CPI_U_RS.xlsx")
cpi <- cpi |> 
  rename(year = Year,
         priceindex = Index) |> 
  transform(year = as.numeric(year))

b25119_cpi <- b25119_data |> 
  left_join(cpi, by = 'year') |> 
  transform(dollars20 = ((381.2/priceindex)*estimate)) |> 
  select(NAME, GEOID, year, tenure, dollars20, cdollars = estimate) |> 
  mutate(NAME = str_remove_all(NAME, ", Virginia")) |>
  filter(tenure != "All households") |> 
  select(year, NAME, tenure, dollars20, cdollars)

write_rds(b25119_cpi, "data/b25119_cpi.rds")

```

```{r med-income-plot}

b25119_cpi <-read_rds("data/b25119_cpi.rds") |> 
  filter(NAME %in% pha_names)

ggplot(b25119_cpi, 
       aes(x = year,
           y = dollars20,
           color = NAME)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~tenure) +
  scale_color_manual(values = geo_colors) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format()) +
  labs(title = "Median houshold income by tenure and locality", color = "Locality")
  

```

```{r med-income-race}

# years <- 2010:2020
# 
# b19013 <- paste0("B19013", LETTERS[2:9])
# 
# b19013_defns <- load_variables(2020, "acs5") %>%
#   filter(str_sub(name, end = 7) %in% b19013) %>%
#   filter(str_detect(name, "PR") == FALSE)
# 
# concept_to_race <- function(x) {
#   out <- x %>%
#     str_remove_all("MEDIAN HOUSEHOLD INCOME IN THE PAST 12 MONTHS \\(\\IN 2020 INFLATION-ADJUSTED DOLLARS\\)\\ \\(|\\)") %>%
#     str_to_title()
# }
# 
# b19013_cleaned <- b19013_defns %>%
#   mutate(race = concept_to_race(concept)) %>%
#   separate(label, c("estimate", "medhhincome"), sep = "!!") %>%
#   select(variable = name, medhhincome, race) %>%
#   mutate(across(.fns = ~replace_na(.x, "All")),
#           across(.fns = ~str_remove_all(.x, ":")))
# 
# b19013_raw <- map_dfr(b19013, function(tb) {
#   yearly_data <- map_dfr(years, function(yr) {
#     
#     acs_pull <- get_acs(
#       geography = "county",
#       table = tb,
#       year = yr,
#       state = "VA"
#     ) %>%
#     left_join(b19013_cleaned, by = "variable")
#     
#     acs_rearranged <- acs_pull %>%
#       mutate(year = yr) %>%
#       select(variable, year, NAME, GEOID, race, medhhincome,
#              estimate, moe)
#     
#     acs_rearranged
#   })
#   yearly_data
# })
# 
# write_rds(b19013_raw, "data/b19013_raw.rds")

b19013_raw <- read_rds("data/b19013_raw.rds")

b19013_data <- b19013_raw |> 
  subset(GEOID %in% rr) |> 
  mutate(across(.fns = ~str_remove_all(.x, "Alone Householder")),
         across(.fns = ~trimws(.x))) |> 
  select(variable, year, NAME, GEOID, race, estimate, moe)

cpi <- read_excel("data/CPI_U_RS.xlsx") |> 
  rename(year = Year,
         priceindex = Index) |> 
  transform(year = as.numeric(year))

b19013_data_clean <- b19013_data |> 
  transform(year = as.numeric(year),
            estimate = as.numeric(estimate))|> 
  left_join(cpi, by = 'year')|> 
  select(variable, year, NAME, GEOID, race, estimate, moe, priceindex) |> 
  transform(dollars20 = ((381.2/priceindex)*estimate)) |> 
  separate(NAME, into = c("locality", "state"), sep = ",") |> 
  mutate(race = case_when(
    race == "Black Or African American" ~ "Black",
    race == "Two Or More Races Householder" ~ "Multiracial",
    race == "White Alone, Not Hispanic Or Latino Householder" ~ "White, non-Hispanic",
    race == "Hispanic Or Latino Householder" ~ "Hispanic or Latino",
    TRUE ~ race
  )) 

race_values = c("White, non-Hispanic", "Black", "Asian", "Multiracial", "Hispanic or Latino")

pha_values = c("Richmond city", "Henrico County", "Hanover County", "Chesterfield County")

b19013_pha <- b19013_data_clean |> 
  subset(race %in% race_values) |> 
  subset(locality %in% pha_values)

inc_race <- gg_line_col_facet(b19013_pha,
            x_var = year,
            y_var = dollars20,
            col_var = race,
            facet_var = locality
) + labs(title = "Median household income by race and ethnicity",
         x = "Year", y = "2020 inflation-adjusted dollars") +
  scale_y_continuous(labels = scales::dollar_format())

plotly:: ggplotly(inc_race) |> 
  plotly_camera()

```
```{r med-income-child}

# Table B19125 Median Family Income by Presence of Own Children

years <- 2016:2020

b19125_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B19125")

b19202_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B19202")

b19125_raw <- map_dfr(years, function(yr){
  b25119_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B19125",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) %>%
    mutate(year = yr)
  })

b19125_raw <- b19125_raw |> 
  subset(GEOID %in% pha)

b19125_vars_cleaned <- b19125_vars |> 
  separate(label, into = c("est", "total", "children"), sep = "!!") |>  
  select(variable = name, children) |> 
  mutate(children = case_when(
    children == "With own children of the householder under 18 years" ~ "With children",
    children == "No own children of the householder under 18 years" ~ "No children"
  )) |> 
  drop_na()

b19125_data <- b19125_raw |> 
  right_join(b19125_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, children, estimate) 

cpi <- read_excel("data/CPI_U_RS.xlsx")
cpi <- cpi |> 
  rename(year = Year,
         priceindex = Index) |> 
  transform(year = as.numeric(year))

b19125_cpi <- b19125_data |> 
    left_join(cpi, by = 'year') |> 
  transform(dollars20 = ((381.2/priceindex)*estimate)) |> 
  select(NAME, GEOID, year, children, dollars20, cdollars = estimate) |> 
  separate(NAME, into = c("locality", "state"), sep = ",") |> 
  select(year, locality, children, dollars20)

ggplot(b19125_cpi, 
       aes(x = year,
           y = dollars20,
           color = children)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~locality) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format()) +
  labs(title = "Median family income by children and locality", color = "Children")

```
Wages
```{r wages}

# Pull in BLS data? QCEW? I haven't found a great way to do this.



```