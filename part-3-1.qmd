# Affordability of current housing supply {#part-3-1}

```{r}
#| label: setup

library(tidyverse)
library(tidycensus)
library(janitor)
library(optiRum)
library(scales)

# rr includes Charles City, Goochland, New Kent, and Powhatan.

rr <- c("51760", "51085", "51087", "51041",
        "51145", "51075", "51127", "51036")

pha <- c("51085", "51760", "51087", "51041")

# Set palette colors; may need to find a palette that better complements the PHA branding.

rr_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County",
              "Powhatan County", "Goochland County", "New Kent County", "Charles City County")

pha_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County")

rr_df <- data.frame(GEOID = rr, NAME = rr_names)

```

## Rental housing gap

Comprehensive Housing Affordability Strategy (CHAS) data provided by the Department of Housing and Urban Development (HUD) allows us to understand the cost of housing in relation to household incomes. For renters making less than 80% AMI across the region, there has been little change in the gap in affordable rental housing. In 2015, there was an overall gap of nearly 40,000 (39,506) rental homes affordable to households making 80% AMI or less. By 2018, that gap had increased by 354 homes to reach a total gap of 39,860.

Increases in the gap occurred mainly among housing between 31 and 80% AMI, but it is important to note that a gap in housing across all income levels impacts households of any income. Households don't just seek housing that directly matches their income. Often times households desire housing that costs less so that they can spend money on other necessities like transportation, healthcare, and food. But when overall supply is low, this means that households with lower incomes have to compete with those higher income households in the open market --- leaving them having to choose more expensive and lower quality housing.

This accentuates the need for new affordable housing at all income levels --- but especially for 30% AMI or below households, where in 2018, there was a shortage of over 22,000 rental homes.

```{r}
#| label: gap-data
#| eval: false

tb_18c <- read_csv("data/Table18C_2015to2018.csv")

colnames(tb_18c)[16] <- "Cost"

renter <- tb_18c |>
  clean_names() |>
  filter(line_type == "Detail") |>
  select(county, fips, year, estimate, tenure, cost, household_income) |>
  group_by(county, fips, year, tenure, cost, household_income) |>
  summarise(estimate = sum(estimate)) |>
  filter(fips %in% rr)

tb_18_match <- renter |>
  filter(tenure == "Renter occupied") |>
  mutate(cost = case_when(
    cost == "greater than RHUD30 and less than or equal to RHUD50" ~ "31 to 50 percent AMI",
    cost == "greater than RHUD50 and less than or equal to RHUD80" ~ "51 to 80 percent AMI",
    cost == "greater than RHUD80" ~ "80 percent AMI or greater",
    cost == "less than or equal to RHUD30" ~ "30 percent AMI or below"
  )) |>
  mutate(household_income = case_when(
    household_income == "greater than 100% of HAMFI" ~ "80 percent AMI or greater",
    household_income == "greater than 80% of HAMFI but less than or equal to 100% of HAMFI" ~ "80 percent AMI or greater",
    household_income == "greater than 50% of HAMFI but less than or equal to 80% of HAMFI" ~ "51 to 80 percent AMI",
    household_income == "greater than 30% of HAMFI but less than or equal to 50% of HAMFI" ~ "31 to 50 percent AMI",
    household_income == "less than or equal to 30% of HAMFI" ~ "30 percent AMI or below"
  )) |>
  group_by(county, fips, year, cost, household_income) |>
  summarise(estimate = sum(estimate))

tb_18_match <- tb_18_match |>
  mutate(match = case_when(
    cost == household_income ~ "Affordable",
    cost == "30 percent AMI or below" & household_income == "31 to 50 percent AMI" ~ "Very affordable",
    cost == "30 percent AMI or below" & household_income == "51 to 80 percent AMI" ~ "Very affordable",
    cost == "30 percent AMI or below" & household_income == "80 percent AMI or greater" ~ "Very affordable",
        cost == "31 to 50 percent AMI" & household_income == "31 to 50 percent AMI" ~ "Affordable",
    cost == "31 to 50 percent AMI" & household_income == "51 to 80 percent AMI" ~ "Very affordable",
    cost == "31 to 50 percent AMI" & household_income == "80 percent AMI or greater" ~ "Very affordable",
        cost == "31 to 50 percent AMI" & household_income == "30 percent AMI or below" ~ "Unaffordable",
    cost == "51 to 80 percent AMI" & household_income == "30 percent AMI or below" ~ "Unaffordable",
        cost == "51 to 80 percent AMI" & household_income == "31 to 50 percent AMI" ~ "Unaffordable",
    cost == "51 to 80 percent AMI" & household_income == "80 percent AMI or greater" ~ "Very affordable",
    cost == "80 percent AMI or greater" & household_income == "30 percent AMI or below" ~ "Unaffordable",
    cost == "80 percent AMI or greater" & household_income == "31 to 50 percent AMI" ~ "Unaffordable",
    cost == "80 percent AMI or greater" & household_income == "51 to 80 percent AMI" ~ "Unaffordable"
  )) |>
  mutate(gapcode = case_when(
    match == "Unaffordable" ~ "Gap",
    TRUE ~ "Matches or less than income"
  ))

write_rds(tb_18_match, "data/tb_18_match.rds")

tb_18_match <- read_rds("data/tb_18_match.rds")

gap <- tb_18_match |>
  filter(fips %in% as.numeric(pha)) |> 
  group_by(year, household_income, gapcode) |>
  summarise(estimate = sum(estimate)) |>
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |>
  filter(household_income != "80 percent AMI or greater")

write_rds(gap, "data/gap.rds")

```


```{r gap-jtk, eval=FALSE}

library(ggsankey)
library(ggalluvial)

gap_jtk <- tb_18_match |>
  ungroup() |> 
  filter(year == 2018) |> 
  mutate(across(.fns = ~str_replace_all(.x, " percent", "%"))) |> 
  group_by(cost, household_income) |> 
  summarise(estimate = sum(estimate))

ggplot(gap_jtk,
       aes(y = estimate,
           axis2 = cost,
           axis1 = household_income)) +
  geom_alluvium(aes(fill = household_income)) +
  geom_stratum() +
  geom_text(stat = "stratum",
            aes(label = after_stat(stratum))) +
  scale_x_discrete(limits = c("Income", "Cost")) +
  theme_void()

```


```{r gap-plot, fig.cap=""}

gap <- read_rds("data/gap.rds")

ggplot(gap,
       aes(x = year, 
           y = estimate,
           fill = gapcode)) +
  geom_bar(stat = "identity") +
  facet_grid(~household_income) +
  theme(axis.title = element_blank()) +
  labs(title = "Rental housing gap by AMI: 2015 to 2018", fill = "Gap/Affordability")

```

## Income versus affordability

Market asking rents across the region have been on the incline between 2016 and 2020. But median renter household income for the region is still not enough to afford asking rents in each locality. That gap is most prominent in the Chesterfield County, where the typical renter can only afford a rent of \$1,098, but the local market asking rent is \$1,265 --- a \$167 gap. The gap is less severe in Hanover County and the City of Richmond where the gap is only about \$30. 

```{r renter-rent}

# Compare regional renter income versus local rental prices

years <- 2016:2020

b25119_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B25119")

b25119_raw <- map_dfr(years, function(yr){
  b25119_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B25119",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) %>%
    mutate(year = yr)
  })

b25119_raw <- b25119_raw |> 
  mutate(NAME = str_remove_all(NAME, ", Virginia")) |> 
  filter(NAME %in% pha_names)

b25119_vars_cleaned <- b25119_vars |> 
  separate(label, into = c("est", "income", "total", "tenure"), sep = "!!") |>  
  select(variable = name, tenure) |> 
  mutate(tenure = case_when(
    tenure == "Owner occupied (dollars)" ~ "Homeowner",
    tenure == "Renter occupied (dollars)" ~ "Renter"
  ))

b25119_vars_cleaned$tenure <- b25119_vars_cleaned$tenure |>  replace_na('All households')

renter_income <- b25119_raw |> 
  right_join(b25119_vars_cleaned, by = "variable") |> 
  filter(tenure == "Renter") |> 
  select(NAME, GEOID, year, estimate)

rr_rent_annual <- read_csv("data/rr_annual_rent.csv") |> 
    pivot_longer(cols = 2:8,
               names_to = "locality",
               values_to = "rent_current") |> 
  clean_names() |> 
  mutate(NAME = str_replace(locality, "City", "city"))

```

```{r}

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names() |> 
  mutate(locality = str_replace(locality, "City", "city")) |> 
  filter(locality %in% pha_names) 

```


```{r}

costs_income <- rr_rent_annual |> 
  left_join(renter_income, by = c("NAME", "year")) |> 
  mutate(rent = parse_number(rent_current)) |> 
  filter(NAME %in% pha_names,
         year > 2015) |> 
  select(4,1,6,7) |>
  select(locality=1,2,income=3,4) |> 
  left_join(rr_sales_annual, by = c("locality", "year"))

```


```{r}

costs_income_change <- costs_income |> 
  group_by(locality) |> 
  arrange(year, .by_group = TRUE) |> 
  mutate(rent_chg = (rent - lag(rent)),
         price_chg = (price - lag(price)),
         inc_chg = (income - lag(income)),
         across(.cols = everything(), ~replace_na(.x, 0))) |> 
  mutate(across(.cols = c(rent_chg, price_chg, inc_chg), ~ cumsum(.x)),
         rent_pct = rent_chg/first(rent),
         price_pct = price_chg/first(price),
         inc_pct = inc_chg/first(income)) |> 
  select(1,2,9:11) |> 
  pivot_longer(cols = 3:5,
               names_to = "type",
               values_to = "pct_chg") |> 
  mutate(pct_chg = case_when(
    year > 2020 & type == "inc_pct" ~ NA_real_,
    TRUE ~ pct_chg)) |> 
  mutate(type = case_when(
    type == "inc_pct" ~ "Income",
    type == "price_pct" ~ "Home price",
    type == "rent_pct" ~ "Rent"
  ))

write_rds(costs_income_change, "data/costs_income_change.rds")

```





```{r}

costs_income_change <- read_rds("data/costs_income_change.rds")
  
ggplot(costs_income_change,
       aes(x = year,
           y = pct_chg,
           color = type)) +
  geom_line(size = 1) +
  facet_wrap(~locality) +
  scale_y_continuous(labels = label_percent()) +
  labs(title = "Cumulative percent change in median renter income and average rent",
       subtitle="2016 to 2022",
       color = "Percent change",
       caption = "Sources: U.S. Census Bureau, American Community Survey, Table B25119,\nCentral Virginia MLS, and CoStar Group, Inc.") +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "right",
        axis.text.x = element_text(angle = 90),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

```

```{r}

rent_income_gap <- rent_income |> 
  mutate(affordable_rent = (estimate/12)*.30) |> 
  mutate(difference = rent_current - affordable_rent) |> 
  drop_na() |> 
  select(year, locality, rent_current, affordable_rent, difference)

rent_gap <- rent_income_gap |> 
  pivot_longer(3:5,
               names_to = "type",
               values_to = "dollars") |> 
  filter(type != "difference") |> 
  subset(locality %in% pha_names) |> 
  mutate(type = case_when(
    type == "rent_current" ~ "Average market asking rent",
    type == "affordable_rent" ~ "Rent affordable to typical renter"
  ))
  
ggplot(rent_gap,
       aes(x = year,
           y = dollars,
           color = type
        )) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~locality) +
  scale_y_continuous(labels = dollar_format()) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
  labs(title = "Market asking rent versus rent affordable to typical renter in the region", color = "Nominal rent")


```

For the typical renter household in the region wanting to enter homeownership, the income needed to afford local home prices remains wide. In every locality, the gap between income needed to afford the median home price and the regional renter income is over \$10,000. Renters are especially hard pressed to afford a home in Hanover County, where the gap is over \$25,000. 

```{r  renter-own}

#Compare renter income versus home prices

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names()

int_annual <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
utilities <- 250 # Assume $250/month for utilities

sale_income <- rr_sales_annual |> 
  left_join(renter_income, by = "year") |> 
  left_join(int_annual, by = "year") |> 
  drop_na() |> 
  mutate(principal = price - (price*downpayment)) |> 
  mutate(loanamt = principal/(1-closingcosts)) |> 
  mutate(mortgage = abs(PMT((annual_int/12), 360, loanamt)) + 250) |> 
  mutate(inc_needed = ((mortgage*10)/2.8)*12) |> 
  select(year, locality, inc_needed, income = estimate)

sale_income_gap <- sale_income |> 
  pivot_longer(3:4,
               names_to = "data",
               values_to = "value") |> 
  mutate(data = case_when(
    data == "income" ~ "Renter median household income",
    data == "inc_needed" ~ "Income needed to afford median home price"
  )) |> 
  subset(locality %in% pha_names)

ggplot(sale_income_gap,
       aes(x = year, 
           y = value,
           color = data)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~locality) +
  labs(title = "Income needed to afford median home price versus median renter income", color = "Nominal dollars") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format())


```

```{r occupations}


```

Ratio
```{r ratio}

# Income of five most common job sectors/occupations versus rental and home prices

```