# Affordability of current housing supply {#part-3-1}

```{r}
#| label: setup

library(tidyverse)
library(tidycensus)
library(janitor)
library(optiRum)
library(scales)

# rr includes Charles City, Goochland, New Kent, and Powhatan.

rr <- c("51760", "51085", "51087", "51041",
        "51145", "51075", "51127", "51036")

pha <- c("51085", "51760", "51087", "51041")

# Set palette colors; may need to find a palette that better complements the PHA branding.

rr_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County",
              "Powhatan County", "Goochland County", "New Kent County", "Charles City County")

pha_names <- c("Richmond city", "Hanover County", "Henrico County", "Chesterfield County")

rr_df <- data.frame(GEOID = rr, NAME = rr_names)

```

## Rental housing gap

```{r}
#| label: gap-data
#| eval: false

tb_18c <- read_csv("data/Table18C_2015to2018.csv")

colnames(tb_18c)[16] <- "Cost"

renter <- tb_18c |>
  clean_names() |>
  filter(line_type == "Detail") |>
  select(county, fips, year, estimate, tenure, cost, household_income) |>
  group_by(county, fips, year, tenure, cost, household_income) |>
  summarise(estimate = sum(estimate)) |>
  filter(fips %in% rr)

tb_18_match <- renter |>
  filter(tenure == "Renter occupied") |>
  mutate(cost = case_when(
    cost == "greater than RHUD30 and less than or equal to RHUD50" ~ "31 to 50 percent AMI",
    cost == "greater than RHUD50 and less than or equal to RHUD80" ~ "51 to 80 percent AMI",
    cost == "greater than RHUD80" ~ "80 percent AMI or greater",
    cost == "less than or equal to RHUD30" ~ "30 percent AMI or below"
  )) |>
  mutate(household_income = case_when(
    household_income == "greater than 100% of HAMFI" ~ "80 percent AMI or greater",
    household_income == "greater than 80% of HAMFI but less than or equal to 100% of HAMFI" ~ "80 percent AMI or greater",
    household_income == "greater than 50% of HAMFI but less than or equal to 80% of HAMFI" ~ "51 to 80 percent AMI",
    household_income == "greater than 30% of HAMFI but less than or equal to 50% of HAMFI" ~ "31 to 50 percent AMI",
    household_income == "less than or equal to 30% of HAMFI" ~ "30 percent AMI or below"
  )) |>
  group_by(county, fips, year, cost, household_income) |>
  summarise(estimate = sum(estimate))

tb_18_match <- tb_18_match |>
  mutate(match = case_when(
    cost == household_income ~ "Affordable",
    cost == "30 percent AMI or below" & household_income == "31 to 50 percent AMI" ~ "Very affordable",
    cost == "30 percent AMI or below" & household_income == "51 to 80 percent AMI" ~ "Very affordable",
    cost == "30 percent AMI or below" & household_income == "80 percent AMI or greater" ~ "Very affordable",
        cost == "31 to 50 percent AMI" & household_income == "31 to 50 percent AMI" ~ "Affordable",
    cost == "31 to 50 percent AMI" & household_income == "51 to 80 percent AMI" ~ "Very affordable",
    cost == "31 to 50 percent AMI" & household_income == "80 percent AMI or greater" ~ "Very affordable",
        cost == "31 to 50 percent AMI" & household_income == "30 percent AMI or below" ~ "Unaffordable",
    cost == "51 to 80 percent AMI" & household_income == "30 percent AMI or below" ~ "Unaffordable",
        cost == "51 to 80 percent AMI" & household_income == "31 to 50 percent AMI" ~ "Unaffordable",
    cost == "51 to 80 percent AMI" & household_income == "80 percent AMI or greater" ~ "Very affordable",
    cost == "80 percent AMI or greater" & household_income == "30 percent AMI or below" ~ "Unaffordable",
    cost == "80 percent AMI or greater" & household_income == "31 to 50 percent AMI" ~ "Unaffordable",
    cost == "80 percent AMI or greater" & household_income == "51 to 80 percent AMI" ~ "Unaffordable"
  )) |>
  mutate(gapcode = case_when(
    match == "Unaffordable" ~ "Gap",
    TRUE ~ "Matches or less than income"
  ))

write_rds(tb_18_match, "data/tb_18_match.rds")

tb_18_match <- read_rds("data/tb_18_match.rds")

gap <- tb_18_match |>
  filter(fips %in% as.numeric(pha)) |> 
  group_by(year, household_income, gapcode) |>
  summarise(estimate = sum(estimate)) |>
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |>
  filter(household_income != "80 percent AMI or greater")

write_rds(gap, "data/gap.rds")

```

Comprehensive Housing Affordability Strategy (CHAS) data provided by the Department of Housing and Urban Development (HUD) allows us to understand the cost of housing in relation to household incomes. For renters making less than 80% AMI across the region, there has been little change in the gap in affordable rental housing.

```{r}
#| label: fig-gap-plot
#| fig.cap: "Rental housing gap by AMI"

gap <- read_rds("data/gap.rds") |>
  mutate(gapcode = case_when(
    gapcode == "Gap" ~ "Unaffordable",
    TRUE ~ "Affordable"
  ))

ggplot(gap,
       aes(x = year, 
           y = estimate,
           fill = gapcode)) +
  geom_col() +
  facet_grid(~household_income) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = "Rental housing gap by AMI",
       subtitle = "2015 to 2018",
       fill = "Affordability of current home") +
  theme(
    legend.position = "bottom",
    axis.title = element_blank(),
    panel.background = element_blank(),
    panel.grid.major.y = element_line(color = "grey95",
                                      size = 0.05),
    axis.ticks = element_blank()
  )

```

In 2015, there was an overall gap of nearly 40,000 rental homes affordable to households making 80% AMI or less. By 2018, that gap had increased by 354 homes to reach a total gap of 39,860.

Increases in the gap occurred mainly among housing between 31 and 80% AMI, but it is important to note that a gap in housing across all income levels impacts households of any income. This accentuates the need for new affordable housing at all income levels --- but especially for 30% AMI or below households. As of 2018, these extremely low-income renters face a shortage of over 22,000 rental homes.

## Incomes versus housing costs

```{r}
#| label: income-costs-data
#| eval: false

# Load income data

b25119_cpi <- read_rds("data/b25119_cpi.rds")

renter_income <- b25119_cpi |> 
  filter(tenure == "Renter",
         NAME %in% pha_names) |> 
  select(NAME, year, estimate = cdollars, dollars20)

# Load rent data

rr_rent_annual <- read_csv("data/rr_annual_rent.csv") |> 
    pivot_longer(cols = 2:8,
               names_to = "locality",
               values_to = "rent_current") |> 
  clean_names() |> 
  mutate(NAME = str_replace(locality, "City", "city"))

# Load sales data

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names() |> 
  mutate(locality = str_replace(locality, "City", "city")) |> 
  filter(locality %in% pha_names) 

# Join rents and sales to incomes

costs_income <- rr_rent_annual |> 
  left_join(renter_income, by = c("NAME", "year")) |> 
  mutate(rent = parse_number(rent_current)) |> 
  filter(NAME %in% pha_names,
         year > 2015) |> 
  select(4,1,6,7) |>
  select(locality=1,2,income=3,4) |> 
  left_join(rr_sales_annual, by = c("locality", "year"))

# Add affordable rents and sales prices

int_rates <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
taxes <- 250 # Assume $250/month for taxes
ins_fees <- 150 # Assume $150/month for insurance and fees

price_calc <-  function(x, y) {
  
  monthly_cost <- x / 12 * 0.28
  monthly_pmt <- monthly_cost - (taxes + ins_fees)
  principal <- monthly_pmt * (((1-1/(1+y)^360))/(y/12))
  loan_amt <- principal/(1-closingcosts)
  price <- (loan_amt * -1) / ((downpayment) - 1)

  price
  
}

costs_income_afford <- costs_income |> 
  left_join(int_rates, by = "year") |> 
  mutate(rent_afford = income / 12 * 0.3) |> 
  mutate(price_afford = price_calc(income, annual_int))

write_rds(costs_income_afford, "data/costs_income_afford.rds")


```

```{r}
#| label: income-costs-change
#| eval: false

costs_income_change <- costs_income |> 
  group_by(locality) |> 
  arrange(year, .by_group = TRUE) |> 
  mutate(rent_chg = (rent - lag(rent)),
         price_chg = (price - lag(price)),
         inc_chg = (income - lag(income)),
         across(.cols = everything(), ~replace_na(.x, 0))) |> 
  mutate(across(.cols = c(rent_chg, price_chg, inc_chg), ~ cumsum(.x)),
         rent_pct = rent_chg/first(rent),
         price_pct = price_chg/first(price),
         inc_pct = inc_chg/first(income)) |> 
  select(1,2,9:11) |> 
  pivot_longer(cols = 3:5,
               names_to = "type",
               values_to = "pct_chg") |> 
  mutate(pct_chg = case_when(
    year > 2020 & type == "inc_pct" ~ NA_real_,
    TRUE ~ pct_chg)) |> 
  mutate(type = case_when(
    type == "inc_pct" ~ "Income",
    type == "price_pct" ~ "Home price",
    type == "rent_pct" ~ "Rent"
  ))

write_rds(costs_income_change, "data/costs_income_change.rds")

```

```{r}
#| label: income-costs-load

costs_income_afford <- read_rds("data/costs_income_afford.rds")

costs_income_change <- read_rds("data/costs_income_change.rds")

```

### Overview

Housing costs---both for-sale prices and rents---have steadily accelerated in the region since 2016. Every locality say home prices rise more than 50 percent, with average rents not far behind. Average renter incomes also increased from 2016 to 2020, although those gains were not as steady across all localities.

```{r}
#| label: fig-costs-inc-change
#| fig.cap: "Cumulative percent change in median renter income, home prices, and average rent"

ggplot(costs_income_change,
       aes(x = year,
           y = pct_chg,
           color = type)) +
  geom_line(size = 1) +
  facet_wrap(~locality, nrow = 1) +
  scale_y_continuous(labels = label_percent()) +
  labs(title = "Cumulative percent change in median renter income,\nhome prices, and average rent",
       subtitle ="2016 to 2022 (ACS income data through 2020)",
       color = "Percent change",
       caption = "Sources: U.S. Census Bureau, American Community Survey, Table B25119,\nCentral Virginia MLS, and CoStar Group, Inc.") +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom",
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

```

However, there are two other important takeaways:

1. Average renter income data is currently only available through 2020, while the sharpest housing price increases occurred from then through 2022.
2. Average renter incomes were already below the level necessary to afford the typical apartment or home for sale.

### Rental affordability

Market asking rents across the region have been on the incline between 2016. Still, the median incomes for renters in Chesterfield and Henrico---at least from 2016 to 2020---could afford average rents. That was not the case for Henrico and Richmond, where the monthly rental price affordability gaps were \$20 and \$218, respectively.

```{r}
#| label: fig-rent-afford
#| fig.cap: "Average rents versus affordable rents for median renter income"

rent_afford <- costs_income_afford |> 
  select(1, 2, 4, 7) |> 
  pivot_longer(cols = 3:4,
               names_to = "type") |> 
  mutate(type = case_when(
    type == "rent" ~ "Average rent",
    TRUE ~ "Affordable rent"
  ))

ggplot(rent_afford,
       aes(x = year,
           y = value,
           fill = type)) +
  geom_col(position = "dodge") +
  facet_wrap(~locality, nrow = 1) +
  scale_x_continuous(n.breaks = 7) +
  scale_y_continuous(labels = label_dollar()) +
  labs(title = "Average rents versus affordable rents for median renter income",
       subtitle ="2016 to 2022 (ACS income data through 2020)",
       caption = "Sources: U.S. Census Bureau, American Community Survey,\nTable B25119 and CoStar Group, Inc.") +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        legend.position = "bottom",
        legend.title = element_blank(),
        axis.text.x = element_text(angle = 90, vjust = 0.5),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

```




For the typical renter household in the region wanting to enter homeownership, the income needed to afford local home prices remains wide. In every locality, the gap between income needed to afford the median home price and the regional renter income is over \$10,000. Renters are especially hard pressed to afford a home in Hanover County, where the gap is over \$25,000. 

```{r  renter-own}

# Compare renter income versus home prices

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names()

int_annual <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
utilities <- 250 # Assume $250/month for utilities

sale_income <- rr_sales_annual |> 
  left_join(renter_income, by = "year") |> 
  left_join(int_annual, by = "year") |> 
  drop_na() |> 
  mutate(principal = price - (price*downpayment)) |> 
  mutate(loanamt = principal/(1-closingcosts)) |> 
  mutate(mortgage = abs(PMT((annual_int/12), 360, loanamt)) + 250) |> 
  mutate(inc_needed = ((mortgage*10)/2.8)*12) |> 
  select(year, locality, inc_needed, income = estimate)

sale_income_gap <- sale_income |> 
  pivot_longer(3:4,
               names_to = "data",
               values_to = "value") |> 
  mutate(data = case_when(
    data == "income" ~ "Renter median household income",
    data == "inc_needed" ~ "Income needed to afford median home price"
  )) |> 
  subset(locality %in% pha_names)

ggplot(sale_income_gap,
       aes(x = year, 
           y = value,
           color = data)) +
  geom_line(stat = "identity", size = 1) +
  facet_wrap(~locality) +
  labs(title = "Income needed to afford median home price versus median renter income", color = "Nominal dollars") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format())


```

```{r occupations}

# Income of five most common job sectors/occupations versus rental and home prices

```

Ratio
```{r ratio}


```