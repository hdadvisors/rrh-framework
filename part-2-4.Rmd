# (PART)Housing supply and market changes {.unnumbered}

## Assessment of naturally-occurring affordable housing (NOAH){#part-2-4}

```{r setup}

library(tidyverse)
library(simplevis)
library(leaflet)
library(htmlwidgets)
library(ggplot2)
library(janitor)
library(sf)
library(sp)
library(viridis)
library(plotly)
library(scales)

# Utilize the same filters as the Chesterfield County Rental Market Analysis. I've changed the star rating to two or less, which coincides with CoStar's analysis.

# CoStar Filters for Properties: Multi-Family, Localities: Chesterfield, Hanover, Henrico,Richmondy City; Construction status: Existing; Stars: 2 or less; Rent type: Market; Max Year Built: 1999

# This returns a total of 478 properties.

# There are about 80 properties that do not have a listed style. Some may be manufactured home parks.

# Append data from MHCCV report for manufactured home communities.

```

```{r noah-map}

noah <- read_csv("data/pha_noah_72822.csv") |> 
  clean_names() |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE) 

pha_names <- c("Richmond City", "Hanover", "Henrico", "Chesterfield")

geo_colors <- setNames(viridis(4), nm = pha_names)

pal <-colorFactor(palette = c("#440154FF", "#31688EFF","#35B779FF", "#FDE725FF"),
                  levels = c("Richmond City", "Hanover", "Henrico", "Chesterfield"))
  
leaflet(noah) |> 
  addProviderTiles(providers$OpenStreetMap.Mapnik) |>
  addCircleMarkers(
    radius = 5,
    color = ~pal(county_name),
    stroke = FALSE)
```

```{r noah-cnt, fig.cap="NOAH units by locality"}

noah_cnt <- noah |> 
  group_by(county_name) |> 
  summarise(n = sum(number_of_units))

noah_cnt_bar <- ggplot(noah_cnt,
                       aes(x= reorder(county_name, -n),
                           y=n,
                           fill=county_name)) +
  geom_bar(stat="identity") +
  coord_flip() +
  labs(title= "NOAH units by locality") +
  theme(axis.title = element_blank(),
        legend.position = "none") +
  scale_fill_manual(values = geo_colors)

ggplotly(noah_cnt_bar) |> 
  plotly_camera()



```

```{r noah-type}


noah_type <- read_csv("data/pha_noah_72822.csv") |> 
  clean_names() |> 
  select(property_address, county_name, property_name, number_of_units, style, year_built) 


```

```{r noah-rents}

noah_rent <- read_csv("data/pha_noah_rent.csv")


```