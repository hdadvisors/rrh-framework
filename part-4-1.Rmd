# (PART) Local summaries {.unnumbered}

# Richmond City {#part-4-1}

This chapter is a summary of the major changes to the City of Richmond's population and housing market in the past five years.

```{r setup}

library(tidyverse)
library(tidycensus)
library(sf)
library(sp)
library(plotly)
library(tidytext)
library(scales)
library(readxl)
library(zoo)
library(lubridate)
library(janitor)
library(tigris)
library(tidytext)

years <- 2016:2020
fips <- 51760
name <- "Richmond city"
costar_name <- "Richmond City"

```

## Takeaways

```
Add short bullet points summarizing major changes
```

## Demographic and socioeconomic changes

### Population changes

Between 2010 and 2020, the U.S. Census Bureau has estimated that the City of Richmond has grown by 11 percent --- an increase of 22,396 residents. Throughout much of the decade the city has been on a slow upward trend until 2020. The 2020 Census estimate shows a slight decline from the 2019 estimate --- a loss of 3,826 residents. This change could be a result of the difficulties associated with [undercounts during the 2020 Census](https://censuscounts.org/whats-at-stake/will-you-count-renters-in-the-2020-census/).

```{r pop, fig.cap=paste0(name, ": Total Population")}

# Add choice of population stat (net change, components, etc)

pop <- read_rds("data/rr_pop_data.rds") |> 
  mutate(GEOID = parse_number(GEOID)) |> 
  filter(counttype != "Forecast",
         GEOID == fips)

pop_bar <- ggplot(pop,
                      aes(x = year,
                          y = value,
                          fill = value)) +
  geom_col() +
  scale_fill_continuous(viridis_pal()) +
  labs(title = paste0(name, ": Total Population"),
       subtitle = "2010 to 2020",
       caption = "Source: U.S. Census Bureau Decennial Census and American Community Survey.") +
  scale_y_continuous(labels = label_comma()) +
  theme(axis.title = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05))

# ggplotly(pop_bar) |> 
#   plotly_camera()

# 2010 to 2020 increase of 22,396 
# 2019 TO 2020 decrease of 3,826

pop_bar

```

Census estimates from 2016 show Richmond gaining more than 2,000 net persons that year who moved from somewhere else in the state or country. However, the city has experienced a net loss in domestic migration since then. The majority of the city's population growth over the past five years has been due to migration from abroad along with natural increases through new births.

```{r comp, fig.cap=paste0(name,": Components of population change"}

change <- read_rds("data/rr_comp_change.rds") |> 
  filter(year %in% as.character(years) | year == "2021") |> 
  filter(NAMELSAD == name)

ggplot(change,
       aes(x = year,
           y = value,
           fill = component)) +
  geom_col() +
  facet_wrap(~component) +
  labs(title = paste0(name,": Components of population change"), 
       subtitle = "2016 through 2021",
       fill = "Component of change",
       caption = "Note: 2020 components of change data not available.\nSource: U.S. Census Bureau, Population Estimates Program.") +
  theme(axis.title = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05)) +
  scale_y_continuous(labels = label_number(big.mark = ",", style_positive = "plus", style_negative = "minus"))

```

### Household characteristics

Between 2016 and 2020, there have been distinct changes between homeowner and renter households in the city. The city has seen a 2,555 increase in homeowner households with no children, while the number of renter household with no children has decreased by 607. At the other end of the spectrum, there has been a significant decrease in renter households with children (-2,192), while there are only 162 fewer homeowner households with children in the city. These trends seem to suggest affordability challenges in the homeownership and rental markets of the city. 

New homeowners without children (and with fewer financial responsibilities) often find it easier to afford a home, while renters with children are finding it difficulty to afford even a rental --- most likely due to lack of larger rental options, as well as increasing costs.

Nonfamily households have seen an increase for both homeowners and renters, but especially for renters (+1,874). This is likely a result of the student population, as well as young professionals, needing additional roommates to afford increasing rents in the city.

```{r children, fig.cap=paste0(name, ": Change in households with children by tenure"}

# Add choice of household stat (HHs with children, HHs with seniors, subfamilies, etc)

b25115 <- read_rds("data/b25115_data.rds") |> 
  filter(NAME == name)

ggplot(b25115,
       aes(x = children, y = change, fill = tenure)) +
  geom_col(position = "dodge") + 
  facet_wrap(~children, nrow = 1, scales = "free_x") +
  scale_y_continuous(labels = label_number(style_positive = "plus", big.mark = ",")) +
  labs(title = paste0(name, ": Change in households with children by tenure"),
       subtitle = "2016 to 2020",
       fill = "Tenure",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B25115.") +
  theme(axis.title = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

```
Since 2016, the number of seniors (65 years and over) has been on the rise in the city --- especially among seniors living alone (+1,695). The rise in seniors living alone is a result of the ongoing [desire of older adults to age in place.](https://www.aarp.org/home-family/your-home/info-2021/home-and-community-preferences-survey.html) As this trend continues, so do concerns for senior ability to age in place comfortably with ongoing home maintenance needs or rising rent on fixed incomes. 

```{r seniors, fig.cap=paste0(name, ": Change in senior population by living arrangement"}

b09020 <- read_rds("data/b09020_data.rds") |> 
  filter(NAME == name) |> 
  mutate(family = str_replace(family, "Group quarters", " "),
         family = fct_relevel(family, "Family", "Nonfamily", " "))

ggplot(b09020,
       aes(y = reorder_within(relationship, change, family),
           x = change,
           fill = relationship)) +
  geom_col(position = "dodge") +
  scale_y_reordered() +
  scale_x_continuous(labels = label_comma()) +
  facet_grid(rows = vars(family), scales = "free_y", space = "free", switch = "y") +
  #scale_y_discrete(labels = function(x) str_wrap(x, width = 10)) +
  labs(title = paste0(name, ": Change in senior population by living arrangement"),
       subtitle="2016 to 2020",
       fill="Tenure",
       caption = "Source: U.S. Census Bureau, American Community Survey, Table B09020.") +
  theme(axis.title = element_blank(),
        #axis.text.x = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.y = element_blank(),
        legend.position = "none",
        panel.grid.major.x = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank(),
        strip.placement = "outside",
        strip.text.y = element_text(angle = 0))

```

### Income and wages

There are wide disparities between homeowner and renter incomes in the City of Richmond. The median homeowner household income (\$79,858) is over double that of the median renter household income (\$36,249). This gap has been persistent in spite of a 16 percent increase in median household income for renters between 2016 and 2020. 

```{r income, fig.cap=paste0(name, ": Median houshold income by tenure")}

# Add choice of income stat (probably median household income of some kind)

b25119_cpi <-read_rds("data/b25119_cpi.rds") |> 
  filter(NAME == name)

ggplot(b25119_cpi, 
       aes(x = year,
           y = dollars20,
           fill = tenure)) +
  geom_col() +
  facet_wrap(~tenure) +
  scale_y_continuous(labels = dollar_format(), limits = c(0, NA)) +
  labs(title = paste0(name, ": Median houshold income by tenure"), 
       color = "Tenure",
       subtitle = "2016 to 2020 | Adjusted to 2020 dollars",
       caption = "Source: U.S. Census Bureau, American Community Survey") +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        legend.position = "none")

# 16 percent increase for renters
# 10 percent increase for homeowners

```

### Persons with disabilities

Independent living difficulties make it necessary for many individuals to seek assisted living facilities or significant modifications to their home to continue to live comfortably. However, both options can be costly --- increasing the need for funding of home accessibility rehabilitation or new accessible housing construction.

Since 2016, there are now over 500 more persons in the city with independent living difficulties. This growth has been among younger adults (under 35) and "young" seniors (65 to 74). The latter group's growth is likely the result of middle-age adults with these difficulties (which saw a large decline) aging into this category in the last five years. 

```{r ind-living, paste0(name, ": Net change in individuals with independent living difficulties by age"}

# Add disability stat (probably independent living difficulty)

b18107 <- read_rds("data/b18107_data.rds") |> 
  filter(NAME == name) |> 
  group_by(age) |> 
  summarise(change = sum(change))

ggplot(b18107,
       aes(x = age,
           y = change,
           fill = age)) +
  geom_col() +
  labs(title=paste0(name, ": Net change in individuals with\nindependent living difficulties by age"),
       subtitle="2016 to 2020",
       caption="Source: U.S. Census Bureau, American Community Survey, Table B18107.") +
  scale_y_continuous(labels = label_comma()) +
  theme(axis.title = element_blank(),
        axis.ticks = element_blank(),
        legend.position = "none",
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05))

```

## Housing supply and market changes

### Homeownership

From the start of 2017 to June 2022, the median home price in the city has increased by 85 percent --- going from \$210,500 to \$389,950.

```{r sales, fig.cap=paste0(name, ": Median home sales price")}

# Median sales price over time

price <- read_csv("data/richmond_med_sales.csv") |> 
  clean_names() |> 
  mutate(geography = name) |> 
  pivot_longer(cols = starts_with("sale"),
    names_to = "label",
    values_to = "med_price",
    values_drop_na = TRUE) |> 
  mutate(year = substr(label, 19,23)) |> 
  select(geography, year, month, med_price)

price$month <- match(price$month, month.abb)

price <- price |> 
  mutate(date = make_date(year, month)) |> 
  mutate(med_price = parse_number(med_price))

ggplot(price,
       aes(x = date,
           y = med_price,
           color = med_price)) +
  geom_line(stat = "identity", size = 1) +
  scale_y_continuous(labels = label_dollar(), limits = c(0, NA)) +
  scale_x_date(date_labels = "%Y", date_breaks = "1 year") +
  labs(title = paste0(name, ": Median home sales price"),
       subtitle = "January 2017 to June 2022",
       caption = "Source: Central Virginia Regional Multiple Listing Service.") +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        legend.title = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05)) +
  scale_color_continuous(type = "viridis", label = dollar_format())


```

### Rental

Rents across the city have steadily risen over the last ten years, accelerating most rapidly in the pandemic's wake since 2020. This trend is present across all of CoStar's five submarkets for the city, especially for Northside and South Richmond. These submarkets have seen some of the largest average rent increases over time, each growing around 40 percent since 2016.

```{r rent-submarket, fig.cap=paste0(name, ": Average asking rent by submarket"}

# Average asking rent over time (by submarket if applicable, maybe by bedroom if no submarkets)

# Disaggregate by Richmond CoStar Submarket

# CoStar Filters: Construction Status - Existing

# Added locality field manually

sub_rent <- read_csv("data/rr_submarket_data.csv") |> 
  clean_names() |> 
  separate(geography, into = c("region", "state", "submarket"), sep = " - ") |> 
  select(period, locality, submarket, "rent" = market_asking_rent_unit, vacancy_rate) |> 
  mutate(rent = parse_number(rent)) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  filter(locality == costar_name)

# Issue with above is that rents are not inflation-adjusted. May need to revisit. I've requested from CoStar to allow for an inflation-adjusted average rent per unit pull, BUT who knows if they can add it. Might consider just having a table with most recent rents.

ggplot(sub_rent,
       aes(x = period,
           y = rent, 
           color = submarket)) +
  geom_line(stat = "identity") + 
  labs(title = paste0(name, ": Average asking rent by submarket"),
       subtitle = "2000 Q1 to 2022 Q3 | Not adjusted for inflation",
       color = "Submarket") +
  scale_y_continuous(labels = label_dollar(), limits = c(0, NA), n.breaks = 7) +
  scale_x_date(date_labels = "%Y", date_breaks = "2 years", limits = as.Date(c("2000-01-01", "2022-09-30"))) +
  theme(axis.title = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05))

```

```{r submarket-table, fig.cap="Change in average rents by Richmond submarket"}

library(kableExtra)
library(formattable)

sub_rent_tbl <- read_csv("data/rr_submarket_data.csv") |> 
  clean_names() |> 
  separate(geography, into = c("region", "state", "submarket"), sep = " - ") |> 
  select(period, locality, submarket, "rent" = market_asking_rent_unit) |> 
  mutate(rent = parse_number(rent)) |> 
  mutate(period = as.Date(as.yearqtr(period, format = "%Y Q%q"), frac = 1)) |> 
  filter(locality == costar_name) |> 
  filter(period == "2022-09-30" | period == "2016-03-31") |> 
  pivot_wider(names_from = period,
              values_from = rent)

sub_tbl <- sub_rent_tbl |> 
  select(2:4) |> 
  mutate(pct_change = (`2022-09-30`-`2016-03-31`)/`2016-03-31`) |> 
  mutate(across(c(2,3), ~currency(.x, digits = 0)),
         pct_change = percent(pct_change, digits = 0)) |> 
  arrange(desc(pct_change))

sub_tbl |> 
  kbl(col.names = c("Richmond submarket", "2016 Q1 Rent", "2022 Q3 Rent", "Percent change")) |> 
  kable_material(c("striped", "hover")) |> 
  footnote(general = "2016 Q1 Rent has not been adjusted for inflation")


```

### Housing assistance

```
Change in number of assisted units (NHPD)
```

### Naturally-occuring affordable housing

```{r noah}

# Add choice of NOAH stat (total number, change in rent, etc) 

# Probably do a histogram by age

rva_noah <- read_csv("data/pha_noah_81722.csv") |> 
  clean_names() |> 
  st_as_sf(coords = c("longitude", "latitude"), crs=4326, remove=FALSE) |> 
  filter(property_name != "Sedgefield" | property_name != "Holidy Mobile Home Park") |> 
  filter(county_name == costar_name)

ggplot(rva_noah,
       aes(x = avg_asking_unit,
           y = ..density..,
           weight = number_of_units)) +
  geom_histogram()
  

```

## Gap analysis


```{r rva-rent-gap}

# Compare local median renter income to average asking rent

b25119_cpi <- read_rds("data/b25119_cpi_rr.rds")

income <- b25119_cpi |> 
  filter(locality == name) |> 
  filter(tenure == "Renter")

rent <- read_csv("data/rr_annual_rent.csv") |> 
    pivot_longer(cols = 2:8,
               names_to = "locality",
               values_to = "rent_current") |> 
  clean_names() |> 
  filter(locality == costar_name)


rent_gap <- income |> 
  left_join(rent, by = "year") |> 
  mutate(rent_current = parse_number(rent_current)) |> 
  mutate(affordable_rent = (cdollars/12)*.30) |> 
  mutate(difference = rent_current - affordable_rent) |> 
  select(year, rent_current, affordable_rent) |> 
  pivot_longer(2:3,
               names_to = "type",
               values_to = "dollars")

rent_gp <- ggplot(rent_gap,
       aes(x = year,
           y = dollars,
           color = type)) +
  geom_line(stat = "identity", size = 1) +
  scale_y_continuous(labels = dollar_format()) +
  theme(axis.title = element_blank(),
        axis.text.x = element_text(angle = 90, hjust = 1, vjust = 1)) +
  labs(title = paste0(name, ": Average asking rent versus rent affordable to typical renter", color = "Nominal rent"))
       
  
ggplotly(rent_gp) |> 
  plotly_camera()

```


```{r  own-gap}

# Compare local renter income versus local home prices

rr_sales_annual <- read_csv("data/rr_annual_sales.csv") |> 
  pivot_longer(cols = 2:9,
               names_to = "locality",
               values_to = "price") |> 
  clean_names() |> 
  filter(locality == costar_name)

int_annual <- read_csv("data/fredmac_int_annual.csv")

downpayment <- 0.05 # 5% downpayment
closingcosts <- 0.015 # 1.5% closing costs
utilities <- 250 # Assume $250/month for utilities

sale <- rr_sales_annual |> 
  left_join(rva_income, by = "year") |> 
  left_join(int_annual, by = "year") |> 
  drop_na() |> 
  mutate(principal = price - (price*downpayment)) |> 
  mutate(loanamt = principal/(1-closingcosts)) |> 
  mutate(mortgage = abs(PMT((annual_int/12), 360, loanamt)) + 250) |> 
  mutate(inc_needed = ((mortgage*10)/2.8)*12) |> 
  select(year, inc_needed, cdollars)

slgap <- sale |> 
  pivot_longer(2:3,
               names_to = "data",
               values_to = "value") |> 
  mutate(data = case_when(
    data == "cdollars" ~ "Renter median household income",
    data == "inc_needed" ~ "Income needed to afford median home price"
  ))

sale_gp <- ggplot(slgap,
       aes(x = year, 
           y = value,
           color = data)) +
  geom_line(stat = "identity", size = 1) +
  labs(title = paste0(name, ": Income needed to afford median home price versus median renter income", color = "Nominal dollars")) +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = dollar_format())

ggplotly(sale_gp) |> 
  plotly_camera()

```
...

### Affordability of current housing stock

```{r gap}
# Add choice of affordability stat (surplus/deficit, income vs prices, etc)

gap <- read_rds("data/tb_18_match.rds") |> 
  filter(county == name) |> 
  group_by(year, household_income, gapcode) |>
  summarise(estimate = sum(estimate)) |>
  mutate(estimate = case_when(
    gapcode == "Gap" ~ estimate * -1,
    gapcode == "Matches or less than income" ~ estimate
  )) |>
  filter(household_income != "80 percent AMI or greater")

gap_bar <- ggplot(gap,
       aes(x = year, 
           y = estimate,
           fill = gapcode)) +
  geom_bar(stat = "identity") +
  facet_grid(~household_income) +
  theme(axis.title = element_blank()) +
  labs(title = paste0(name, ": Rental housing gap by AMI: 2015 to 2018"), fill = "Gap/Affordability")

ggplotly(gap_bar) |> 
  plotly_camera()

```

### Impact of housing costs


```{r cb}

cb_7 <- read_rds("data/cb_7.rds")

cb <- cb_7 |> 
  filter(county == name,
         cb_group == "Cost-burdened") |> 
  group_by(year, county, tenure) |> 
  summarise(estimate = sum(estimate)) |> 
  group_by(county, tenure) |> 
  mutate(change = estimate - lag(estimate)) |> 
  drop_na() |> 
  mutate(run_diff = cumsum(change))
  
ggplot(cb,
       aes(x = year, y = run_diff, fill = tenure)) +
  geom_col(position = "dodge") +
  facet_wrap(vars(county)) +
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Cumulative change in cost-burdened households by tenure"),
       subtitle = "2015 to 2018",
       fill = "Tenure",
       caption = "Source: U.S Department of Housing and Urban Development,\nComprehensive Housing Affordability Strategy (CHAS), Table 7.") +
  theme(axis.title = element_blank())


```
Add choice of housing cost stat (cost burden, PIT, eviction filings, etc)
```{r evictions}

evictions <- read_csv("data/evictions_17_22.csv") |> 
  pivot_longer(3:128,
               names_to = "data",
               values_to = "value") |> 
  mutate(type = case_when(
    str_detect(data, "Filings") ~ "Filings",
    str_detect(data,"Evictions") ~ "Eviction judgement"
  )) |> 
  mutate(date = str_sub(data, -7, -1)) |> 
  mutate(date = ym(date)) |> 
  mutate(year = year(date)) |> 
  mutate(type = fct_relevel(type, "Filings", "Eviction orders")) |> 
  filter(Jurisdiction == costar_name)

eviction_colors <- setNames(c("#00BFC4", "#F8766D"), nm = c("Filings", "Eviction orders"))

ggplot(evictions,
       aes(x = date,
           y = value,
           fill = type)) +
  geom_col(position = "dodge") +
  scale_y_continuous(labels = label_comma()) +
  labs(title = paste0(name, ": Evictions filings and orders by locality",
       subtitle = "January 2017 to March 2022",
       caption = "Source: RVA Eviction Lab") +
  scale_fill_manual(values = eviction_colors) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        axis.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.major.y = element_line(color = "grey95",
                                          size = 0.05),
        axis.ticks = element_blank())

```
