# (PART)Demographic and socioeconomic changes {.unnumbered}

## Special populations{#part-1-4}

```{r setup}

library(tidyverse)
library(tidycensus)
library(ggplot2)
library(simplevis)

```


```{r ind-living}

# Table B18107 Sex by age by independent living difficulty

# "Because of a physical, mental, or emotional problem, having difficulty doing errands alone such as visiting a doctorâ€™s office or shopping (DOUT)."

years <- 2016:2020

b18107_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B18107")

b18107_raw <- map_dfr(years, function(yr){
  b10107_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B18107",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
  })

b18107_raw <- b18107_raw |> 
  subset(GEOID %in% pha)

b18107_vars_cleaned <- b18107_vars |> 
  separate(label, into = c("est", "total", "sex", "age", "indliv"), sep = "!!") |> 
  select(variable = name, sex , age, indliv) |> 
  drop_na() |> 
  mutate(across(.fns = ~str_remove_all(.x, ":")))

b18107_data <- b18107_raw |> 
  right_join(b18107_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, sex, age, indliv, estimate) |> 
  separate(NAME, into = c("locality", "state"), sep = ",") |> 
  group_by(year, age, indliv) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(indliv == "With an independent living difficulty") |> 
  pivot_wider(names_from = year,
              values_from =  estimate) |> 
  transform(change = `2020` - `2016`) |> 
  select(age, indliv, change)

ggplot(b18107_data,
       aes(x = age,
           y = change)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  scale_x_discrete(labels = rev) +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  theme(axis.title = element_blank()) +
  labs(title = "Change in population with independent living difficulty by age: \n2016 to 2020")
  



```

```{r vets}

# Table B21005 Age by veteran status by employment status for civilian population 18 to 64 years

years <- 2016:2020

b21005_vars <- load_variables(2020, "acs5") |> 
  filter(str_sub(name, end = 6) %in% "B21005")

b21005_raw <- map_dfr(years, function(yr){
  b21005_pull <- get_acs(
    geography = "county",
    state = "VA",
    table = "B21005",
    year = yr,
    survey = "acs5",
    cache_table = TRUE
  ) |> 
    mutate(year = yr)
  })

b21005_raw <- b21005_raw |> 
  subset(GEOID %in% pha)

b21005_vars_cleaned <- b21005_vars |> 
  separate(label, into = c("est", "total", "age", "vet", "labor", "emp"), sep = "!!") |> 
  select(variable = name, age, vet, labor, emp) |> 
  mutate(emp = case_when(
    labor == "Not in labor force" ~ "Not in labor force",
    TRUE ~ emp
  )) |> 
  drop_na() |> 
  mutate(across(.fns = ~str_remove_all(.x, ":")))

b21005_data <- b21005_raw |> 
  right_join(b21005_vars_cleaned, by = "variable") |> 
  select(NAME, GEOID, year, vet, emp, estimate) |> 
  separate(NAME, into = c("locality", "state"), sep = ",") |> 
  group_by(year, vet, emp) |> 
  summarise(estimate = sum(estimate)) |> 
  filter(vet == "Veteran",
         emp != "Employed")


ggplot(b21005_data,
       aes(x = year,
           y = estimate,
           fill = emp)) +
  geom_bar(stat = "identity", position = "stack") +
  theme(axis.title = element_blank()) +
  scale_y_continuous(labels = number_format(big.mark = ",")) +
  labs(title = "Non-working veteran population: 2016 to 2020", fill = "Status")

```